<html>
  <head>
    <META http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Freespace Management System</title>
    <link rel="stylesheet" type="text/css" href="../../style.css">
  </head>
  <body>
    <div class="CommonContent">
      <div class="CommonContentArea">
        <h1>Freespace Management System</h1><p></p><p>Db4o Freespace manager is a special system that is responsible for allocating, discarding,&nbsp;merging of space for db4o usage and keeping database size at minimum</p><p><span>Db4o organizes its files into variable-sized slots with one degree of indirection (pointer slots).&nbsp;The physical address of a pointer slot corresponds to the internal ID of the respective object.&nbsp;On the lowest level the database file is seen as a uniform pool of bytes, from which slots of&nbsp;variable size can be allocated.<br><br>Freespace manager keeps track of the portions of the database file that haven't been allocated&nbsp;for use and gets notified when slots are 'freed', i.e. returned back to the pool.&nbsp;&nbsp;<br><br>That is how it works:<br>- All objects are written to the database file immediately, when they are stored or updated. <br>- Updated objects get a new or previously freed place in the database file. <br>- New or modified pointers to new or modified objects are stored in RAM. <br>- Old and deleted objects are marked as 'freespace'.<br><br>When there is no free slot of the requested size, the file will grow. Adjacent free slots are merged on&nbsp;the fly, but to cluster free and used slots together it is necessary to explicitly invoke <a href="../../Db4o_Database_Management/Maintenance/Defragment.html" class="wikiLink">Defragment</a>.&nbsp;So db4o file will never shrink, unless defragmented, but freed slots will be reused if possible. <br>In general case each persisted object occupies one slot. This slot contains metadata,&nbsp;values of direct primitive members and references to the slots of non-primitive members. What&nbsp;actually goes directly into a slot and what is external is not fixed and differs from version to version.&nbsp;However, there is one level of indirection: a reference to a non-primitive member will not refer to the&nbsp;member's slot directly, but rather to the 'pointer', which is an 8 byte slot containing the address in the&nbsp;file and the data length. The address of this pointer slot is the object's internal ID that is used for indexing, etc.<br><br>For a simple example, assume we have<br><table cellpadding="3" cellspacing="0"><tr><td class="lg">class Car { String manufacturer; }<br>class Driver { String name; Car car; } </td></tr></table><br>and an object graph like this<br><table cellpadding="3" cellspacing="0"><tr><td class="lg">Driver: name='Barrichello', car={Car: manufacturer='BMW'}</td></tr></table><br>This will translate into four slots<br><br><i>1234: [4711, length(Driver)]<br>4711: [Driver,'Barrichello',0815]<br>0815: [4321, length(Car)]<br>4321: [Car,'BMW']</i><br><br>with 1234 being the db4o ID of the driver and 0815 the ID of the car. Whenever the driver or the car object is&nbsp;updated, its actual slot may be stored somewhere else, but the pointer slot (the ID) will remain the&nbsp;same and keep track of the slot's address. (Please, note that this is a simplified example: actual&nbsp;implementation uses more slots and more sophisticated processing).<br><br></span></p></div>
    </div>
    <div id="footer">
					This revision (4) was last Modified 2006-11-12T18:32:15 by Tetyana.
				</div>
  </body>
</html>