<?xml version="1.0"?>
<project name="omj" default="build">
	
	<import file="common.xml" />
	
	<property name="omej.version" value="1.0.4" />
	<property name="dir.project.ome.core" location="${dir.workspace}/com.db4o.ome" />
	<property name="dir.project.ome.help" location="${dir.workspace}/com.db4o.ome.help" />
	<property name="dir.dist.ome" location="${dir.dist}/ome/java" />
	<property name="dir.dist.ome.classes" location="${dir.dist.ome}/classes" />
	<property name="dir.dist.ome.jars" location="${dir.dist.ome}/jars" />
	<property name="dir.dist.ome.temp" location="${dir.dist.ome}/temp" />
	<property name="file.omej.manifest.tmp" location="${dir.dist.ome.temp}/MANIFEST.MF" />
	
	<macrodef name="build-plugin">
		
		<attribute name="name" />
		<attribute name="basedir" />
		<attribute name="classesdir" default="${dir.dist.ome.classes}/@{name}" />
		
		<element name="additionalclasspath" optional="true" />
		<element name="additionaljarcontent" optional="true" />
		
		<sequential>
			<mkdir dir="@{classesdir}" />
			
			<javac fork="true"
				debug="true"
				target="1.5"
				source="1.5"
				destdir="@{classesdir}"
				srcdir="@{basedir}/src"
				encoding="UTF-8">
				<classpath>
					<fileset dir="${eclipse.home}/plugins">
						<include name="org.eclipse.osgi_*/osgi.jar" />
						<include name="org.eclipse.core.resources_*/resources.jar" />
						<include name="org.eclipse.core.runtime_*/runtime.jar" />
						<include name="org.eclipse.jdt.core_*/jdtcore.jar" />
						<include name="org.eclipse.osgi_*.jar" />
						<include name="org.eclipse.core.resources_*.jar" />
						<include name="org.eclipse.core.runtime_*.jar" />
						<include name="org.eclipse.jdt.core_*.jar" />
						<include name="org.eclipse.jdt.launching_*.jar" />
						<include name="org.eclipse.equinox.*.jar" />
						<include name="org.eclipse.core.jobs_*.jar" />
						<include name="org.eclipse.ui_*.jar" />
						<include name="org.eclipse.swt_*.jar" />
						<include name="org.eclipse.jface_*.jar" />
						<include name="org.eclipse.core.commands_*.jar" />
						<include name="org.eclipse.ui.workbench_*.jar" />
						
					</fileset>
					
					<pathelement location="${file.java5.jar}" />

					<additionalclasspath />
				</classpath>
			</javac>
			
			<copy file="@{basedir}/META-INF/MANIFEST.MF.TM" tofile="${file.omej.manifest.tmp}" overwrite="true">
				<filterset>
					<filter token="OMEJ_VERSION" value="${omej.version}" />
					<filter token="DB4O_JAR_NAME" value="${filename.java5.jar}" />
				</filterset>
			</copy>
			
			<jar destfile="${dir.dist.ome.jars}/@{name}_${omej.version}.jar" manifest="${file.omej.manifest.tmp}">
				<fileset dir="@{classesdir}">
					<include name="**/*.class"/>
				</fileset>
				<fileset dir="@{basedir}">
					<include name="plugin.xml"/>
					<include name="build.properties"/>
				</fileset>
				<additionaljarcontent />
			</jar>
		
		</sequential>
	</macrodef>

	<target name="build" depends="init">
		
		<build-plugin name="com.db4o.ome" basedir="${dir.project.ome.core}">
			<additionalclasspath>
				<fileset dir="${dir.project.ome.core}/lib">
					<include name="**/*.jar" />
					<exclude name="**/db4o-*-java5.jar" />
				</fileset>
			</additionalclasspath>
			<additionaljarcontent>
				<fileset dir="${dir.project.ome.core}">
					<include name="ContactSales/**/*" />
					<include name="FAQ/**/*" />
					<include name="icons/**/*" />
					<include name="lib/**/*.jar" />
					<exclude name="lib/**/db4o-*-java5.jar" />
				</fileset>
				<fileset file="${file.java5.jar}" />
			</additionaljarcontent>
		</build-plugin>
		<build-plugin name="com.db4o.ome.help" basedir="${dir.project.ome.help}">
			<additionaljarcontent>
				<fileset dir="${dir.project.ome.help}">
					<include name="html/**/*" />
					<include name="toc.xml" />
				</fileset>
			</additionaljarcontent>
		</build-plugin>
		
	</target>
	
	<target name="init" depends="properties">
		<mkdir dir="${dir.dist.ome.jars}" />
		<mkdir dir="${dir.dist.ome.temp}" />
	</target>
	
	<target name="clean">
		<reset-dir dir="${dir.dist.ome}" />
	</target>
</project>