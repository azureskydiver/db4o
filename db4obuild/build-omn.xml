<?xml version="1.0"?>
<project name="omnbuild-project" default="build-omn" basedir=".">
	<import file="common-dotnet.xml" />
	
	<target name="build-omn" depends="properties, prepare-build" description="Builds OMN">
		<property 
			name="devenv.executable.vs2008" 
			location="${env.ProgramFiles}/Microsoft Visual Studio 9.0/Common7/IDE/devenv.exe" />
	
		<exec executable="${devenv.executable.vs2008}" resultproperty="omn-build-result">
			<arg file ="${file.omn-solution}"/>
			<arg value="/Rebuild" />
			<arg value="Release" />
			<arg value="/out" />
			<arg file="${file.omn-build-log}" />
		</exec>
		
		<if >
			<not><equals arg1="${omn-build-result}" arg2="0"/></not>
			<then>
				<loadfile property="omn-buil-log" srcfile="${file.omn-build-log}" />
				<echo message="${omn-buil-log}" />
				<fail message="OMN build failed. Check this log to find out the reason." />
			</then>
		</if>

		<move file = "${dir.omn.dist.src}/OMInstaller/Release/ObjectManagerEnterprise-vs2005.msi" tofile="${dir.omn.dist}/ObjectManagerEnterprise-vs2005-${db4o.version.dotted}.msi" overwrite="true"/>
		<move file = "${dir.omn.dist.src}/OMInstaller_VS2008/Release/ObjectManagerEnterprise-vs2008.msi" tofile="${dir.omn.dist}/ObjectManagerEnterprise-vs2008-${db4o.version.dotted}.msi" overwrite="true"/>		
	</target>
	
	<target name="prepare-build" depends="properties">
		<property name="dir.omn.dist.src"  value="${dir.dist.net.src.tools}/omn" />
		<property name="file.omn-build-log" value = "${dir.omn.dist}/omn-build.log" />
		<property name="file.omn-solution" value = "${dir.omn.dist.src}/OMAddin.sln" />

		<reset-dir dir="${dir.omn.dist}" />
		<reset-dir dir="${dir.omn.dist.src}" />
		
		<copy todir="${dir.omn.dist.src}" description="copy omn sources to build...">
            <fileset dir="${dir.omn.src}">
                <include name="**/*" />
            </fileset>
		</copy>		
		
		<copy file="${dir.dist.dll}/Db4objects.Db4o.dll" todir="${dir.omn.dist.src}/OM+/bin/Dependencies" overwrite="true"/>
			
		<updateAssemblyInfo version="${db4o.version.iteration.revision}">
			<fileset dir="${dir.omn.dist.src}">
				<include name="**/AssemblyInfo.cs" />
			</fileset>
		</updateAssemblyInfo>
	</target>
</project>