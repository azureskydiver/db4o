<project name="db4oandroid-tests" default="run-tests">
	<import file="common.xml" />
	
	<property name="android.apilevel" value="android-7" />
	<property name="emulator.device" value="android-2.1" />
	
	<property name="android.emulator.port" value="5568" />
	<property name="android.emulator.serial.number" value="emulator-${android.emulator.port}" />
	
	<property name="db4o.junit.package.name" value="com.db4o.junit.launcher" />
	<property name="db4o.junit.class.test.main" value="${db4o.junit.package.name}/Db4oTestCasesLauncher" />

	
	<taskdef name="dumpstderr" classname="com.db4o.devtools.ant.DumpStderrTask">
		<classpath>
			<pathelement location="${dir.build.bin}"/>
		</classpath>
	</taskdef>
		
	<property name="dir.android.tools" value="${dir.android.home}/tools" />
	<property name="dir.android.platform.home" value="${dir.android.home}/platforms/${android.apilevel}" />
	<property name="dir.android.platform.tools" value="${dir.android.platform.home}/tools" />
	<property name="file.jar.android" value="${dir.android.platform.home}/android.jar" />
	
	<property name="file.android.tool.adb" value="${dir.android.tools}/${android.tool.adb}" />
	
	<property name="file.keystore" value="${user.home}/.keystore" />
	<property name="keystore.password" value="kistoa" />
	<property name="keystore.alias" value="db4objects" />
	
	<property name="file.dex.classes" value="${dir.dist.android}/classes.dex" />
	<property name="file.apk.resources" value="${dir.dist.android}/resources.apk" />
	<property name="file.apk.unsigned" value="${dir.dist.android}/db4otests.unsigned.apk" />
	<property name="file.apk" value="${dir.dist.android}/db4otests.apk" />

	<target name="run-tests" depends="sign-apk, run-emu" />
	
	<target name="run-emu" depends="start-emu, uninstall-package, install-package, run-tests-on-emulator, stop-emu, check-failure" />

	<target name="clean">
		<delete failonerror="false">
			<fileset dir="${dir.dist.android}">
			    <include name="**/*"/>
			</fileset>
			<fileset dir="${dir.dist.db4ojunit.classes}">
			    <include name="**/*"/>
			</fileset>
		</delete>
	</target>

	<target name="compile" depends="android-init">
		<mkdir dir="${dir.dist.classes.db4ojunit}" />
		<javac srcdir="${dir.db4ojunit}/src" destdir="${dir.dist.classes.db4ojunit}">
			<classpath>
				<pathelement location="${file.junit.jar}" />
				<pathelement location="${file.jdk1.5.nodep.jar}" />
				<pathelement location="${dir.dist.classes.db4ounit.jdk1.5}" />
				<pathelement location="${dir.dist.classes.test.jdk1.5}" />
			</classpath>
		</javac>
	</target>

	<target name="android-init" depends="properties">

		<property name="android.dependencies" value="${file.jdk1.5.nodep.jar} ${file.jdk1.5.db4ounit.jar} ${dir.dist.classes.test.jdk1.5}" />
		
		<mkdir dir="${dir.dist.android}" />
	
	</target>
	
	<target name="dex" depends ="android-init,compile">
		<exec executable="${dir.android.platform.tools}/${android.tool.dx}">
			<arg value="--dex" />
			<arg value="--output=${file.dex.classes}" />
			<arg line="${dir.dist.classes.db4ojunit} ${android.dependencies}" />
		</exec>
	</target>
	
	<target name="package-resources" depends ="android-init">
		<exec executable="${dir.android.platform.tools}/${android.tool.aapt}">
			<arg value="p" />
			<arg line="-M ${dir.config}/android/AndroidManifest.xml" />
			<arg line="-F ${file.apk.resources}" />
			<arg line="-I ${file.jar.android}" />
			<arg value="-f" />
		</exec>
	</target>
	
	<target name="merge-apk" depends="dex, package-resources">
		<exec executable="${dir.android.tools}/${android.tool.apkbuilder}">
			<arg value="${file.apk.unsigned}" />
			<arg value="-u" />
			<arg line="-f ${file.dex.classes}" />
			<arg line="-z ${file.apk.resources}" />
		</exec>
	</target>
	
	<target name="sign-apk" depends="merge-apk">
		<signjar
			keystore="${file.keystore}"
			alias="${keystore.alias}" 
			storepass="${keystore.password}" 
			jar="${file.apk.unsigned}"
			signedjar="${file.apk}" />
	</target>
	
	<target name="start-emu" unless="emulator-available">
		<exec executable="${file.android.tool.adb}" spawn="true">
			<arg value="start-server" />
		</exec>
		<exec executable="${dir.android.tools}/${android.tool.emulator}" spawn="true">
			<arg line="-avd ${emulator.device}" />
			<arg value="-no-window" />
			<arg value="-noaudio" />
			<arg value="-port" />
			<arg value="${android.emulator.port}" />
		</exec>
		
		<!-- Big fat hack to stay away (but not rid) of race conditions between running the adb deamon and waiting for the device in windows -->
		<sleep seconds="3" />
		
		<exec executable="${file.android.tool.adb}">
			<arg line="-s ${android.emulator.serial.number}" />
			<arg value="wait-for-device" />
		</exec>
	</target>
	
	<target name="stop-emu" unless="emulator-available">
		<exec executable="${file.android.tool.adb}">
			<arg line="-s ${android.emulator.serial.number}" />
			<arg line="emu kill"/>
		</exec>

		<condition property="inWindows">
			<os family="windows"/>
		</condition>
		<antcall target="kill-emulator-on-windows" />
		
		<exec executable="${file.android.tool.adb}">
			<arg line="-s ${android.emulator.serial.number}" />
			<arg value="kill-server"/>
		</exec>
	</target>
	
	<!-- required in windows to make sure the emulator is killed because "adb emu kill" apears to be buggy in that OS -->
	<target name="kill-emulator-on-windows" if="inWindows">
		<exec executable="taskkill">
			<arg line="/f /im ${android.tool.emulator}" />
		</exec>
	</target>
	
	<target name="install-package" depends="start-emu">
		<exec executable="${file.android.tool.adb}">
			<arg line="-s ${android.emulator.serial.number}" />
			<arg value="install" />
			<arg line="-r ${file.apk}" />
		</exec>
	</target>

	<target name="uninstall-package" depends="start-emu">
		<exec executable="${file.android.tool.adb}">
			<arg line="-s ${android.emulator.serial.number}" />
			<arg value="uninstall" />
			<arg value="${db4o.junit.package.name}" />
		</exec>
	</target>

	<target name="run-tests-on-emulator" depends="install-package">
		<delete failonerror="false">
			<fileset dir="${dir.dist.android}">
			    <include name="db4o-tests-output.txt"/>
			</fileset>
		</delete>
		<exec executable="${file.android.tool.adb}" outputproperty="test.output" logerror="true">
			<arg line="-s ${android.emulator.serial.number}" />
			<arg value="shell" />
			<arg value="am" />
			<arg value="instrument" />
			<arg value="-w" />
			<arg line="-e class ${db4o.junit.class.test.main}" />
			<arg value="${db4o.junit.package.name}/android.test.InstrumentationTestRunner" />
		</exec>
		<echo message="${test.output}" />
		<exec executable="${file.android.tool.adb}" outputproperty="test.output" logerror="true">
			<arg line="-s ${android.emulator.serial.number}" />
			<arg value="pull" />
			<arg value="/sdcard/db4o-tests-output.txt" />
			<arg value="${dir.dist.android}/db4o-tests-output.txt" />
		</exec>
	</target>
	
	<target name="check-failure" depends="run-tests-on-emulator">
		<dumpstderr file="${dir.dist.android}/db4o-tests-output.txt" />
		<fail>
			<condition>
				<not>
					<contains string="${test.output}" substring="OK (1 test)" />
				</not>
			</condition>
		</fail>
	</target>
	
	
</project>