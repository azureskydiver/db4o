<?xml version="1.0"?>
<project name="drs.net" default="package">
	<import file="common.xml" />

	<property name="drs.dir" location="${dir.workspace}/drs" />
	<property name="drs.dll" location="${drs.dir}/drs.net/bin/drs.dll" />
	<property name="drs.test.exe" location="${drs.dir}/drs.net/bin/drs.test.exe" />
    <property name="drs.quickstart.exe" location="${drs.dir}/drs.net/bin/drs.quickstart.exe" />
    
	<property name="drs.src.dir" location="${drs.dir}/src" />
	<property name="drs.net.dir" location="${drs.dir}/drs.net" />
    <property name="drs.overlay.dir" location="${drs.dir}/overlay" />
    
	<property name="drs.net.bin.dir" location="${drs.net.dir}/bin" />	
	<property name="drs.net.src.dir" location="${drs.net.dir}/drs/src" />
	<property name="drs.net.in.dir" location="${drs.overlay.dir}/drs/" />
	<property name="drs.net.tests.in.dir" location="${drs.overlay.dir}/drs.tests/" />
    
	<property name="drs.conversion.workspace.dir" location="${dir.dist}/drs.net/workspace" />
	
    
    
	<condition property="mono" value="1">
		<os family="unix" />
	</condition>
    
    <target name="package" depends="rebuild, run-tests">
        <mkdir dir="${drs.dir}/dist" />
        
        <zip destfile="${drs.dir}/dist/dRS-net-${db4o.version.major}.${db4o.version.minor}.zip">
            <fileset dir="${drs.net.dir}" />
        </zip>
    </target>
    
	<target name="rebuild" depends="reset-workspace, build-all" />

	<target name="build-all" depends="update-csharp-projects, prepare-quickstart">
		<csc outputfile="${drs.dll}"
			executable="${csc.executable}"
			targettype="library"
			srcdir="${drs.net.src.dir}">
			<reference dir="${drs.net.bin.dir}">
				<include name="${file.name.dll}" />
				<include name="${file.name.dll.db4ounit}" />
			</reference>
		</csc>
	
		<csc outputfile="${drs.test.exe}"
				executable="${csc.executable}"
				targettype="exe"
                mainclass="Db4objects.Drs.Test.Db4oTests"
				srcdir="${drs.net.dir}/drs.tests/src">
				<reference dir="${drs.net.bin.dir}">
					<include name="drs.dll" />
					<include name="${file.name.dll}" />
					<include name="${file.name.dll.db4ounit}" />
				</reference>
		</csc>
        
        <csc outputfile="${drs.quickstart.exe}"
				executable="${csc.executable}"
				targettype="exe"
				srcdir="${drs.net.dir}/QuickStart/Db4objects.Drs.Quickstart">
				<reference dir="${drs.net.bin.dir}">
					<include name="drs.dll" />
					<include name="${file.name.dll}" />
				</reference>
		</csc>
	</target>
    
    <target name="run-tests" depends="rebuild">
        <exec executable="${drs.test.exe}" failonerror="true" />
    </target>
	
	<target name="create-jar-for-dependencies">
		<mkdir dir="${drs.conversion.workspace.dir}/lib" />
		<property name="dependencies.jar" location="${drs.conversion.workspace.dir}/lib/dependencies.jar" />
		<!--TODO FIXME -remove the /bin Eclipse dependencies-->
		<jar destfile="${dependencies.jar}">			
			<fileset dir="${dir.workspace}/db4oj/bin/">								
			</fileset>
			<fileset dir="${dir.workspace}/db4ojdk1.2/bin/">								
			</fileset>
			<fileset dir="${dir.workspace}/db4ojdk5/bin/">								
			</fileset>
			<fileset dir="${dir.workspace}/db4ounit/bin/">
			</fileset>
			<fileset dir="${dir.workspace}/db4ounit.extensions/bin/">
			</fileset>
			<fileset dir="${dir.workspace}/db4oj.tests/bin">
			</fileset>
		</jar>
	</target>

	<target name="sharpen-drs" depends="prepare-conversion-workspace, install-javatocsharp-plugin">
		<sharpen resource="drs/core" workspace="${drs.conversion.workspace.dir}">
			<args>
				<arg value="-cp" />
				<arg value="${dependencies.jar}" />
				
				<arg value="-srcfolder" />
				<arg value="test" />
				
				<arg value="@sharpen-dRS-options" />
			</args>
		</sharpen>
	</target>

	<target name="update-drs-project" depends="sharpen-drs">
		<delete dir="${drs.net.src.dir}" />
		<mkdir dir="${drs.net.src.dir}" />
		<copy todir="${drs.net.src.dir}">
			<fileset dir="${drs.conversion.workspace.dir}/drscsharp/src">
				<include name="**/*.cs" />
				<exclude name="**/Test/**" />
			</fileset>
		</copy>

		<copy todir="${drs.net.dir}/drs" overwrite="true">
			<fileset dir="${drs.net.in.dir}">
				<include name="**/*" />
			</fileset>
		</copy>
		
		<updatecsharpproject projectfile="${drs.net.dir}/drs/drs.csproj">
			<sources dir="${drs.net.dir}/drs">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject>
	</target>
	
	<target name="update-drs.tests-project" depends="sharpen-drs">
		<copy todir="${drs.net.dir}/drs.tests/src">
			<fileset dir="${drs.conversion.workspace.dir}/drscsharp/src">
				<include name="**/Test/**" />
			</fileset>
		</copy>

		<!---->
		<copy todir="${drs.net.dir}/drs.tests/" overwrite="true">
			<fileset dir="${drs.net.tests.in.dir}">
				<include name="**/*" />
			</fileset>
		</copy>
		<!---->

		<updatecsharpproject projectfile="${drs.net.dir}/drs.tests/drs.tests.csproj">
			<sources dir="${drs.net.dir}/drs.tests">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject>
	</target>

	

	<target name="update-csharp-projects" depends="update-drs-project, update-drs.tests-project">				
	</target>
	
	<target name="reset-workspace" depends="init">
		<delete dir="${drs.conversion.workspace.dir}" />
		<mkdir dir="${drs.conversion.workspace.dir}" />
	</target>

	<target name="prepare-conversion-workspace" depends="create-jar-for-dependencies">
		<copy todir="${drs.conversion.workspace.dir}/drs">
			<fileset dir="${drs.src.dir}">
				<include name="core/**/*.java" />
				<include name="test/**/test/ByteArrayTest.java" />
				<include name="test/**/test/ByteArrayHolder.java" />
				<include name="test/**/test/Db4oClientServerDrsFixture.java" />
				<include name="test/**/test/Db4oDrsFixture.java" />
				<include name="test/**/test/Db4oTests.java" />
				<include name="test/**/test/DrsFixture.java" />				
				<include name="test/**/test/DrsTestCase.java" />
				<include name="test/**/test/DrsTestSuite.java" />
				<include name="test/**/test/DrsTestSuiteBuilder.java" />					
				<include name="test/**/test/IByteArrayHolder.java" />
				<include name="test/**/test/ReplicationProviderTest.java" />
				<include name="test/**/test/GetByUUID.java" />
				<include name="test/**/test/TheSimplest.java" />
				<include name="test/**/test/SPCChild.java" />
				<include name="test/**/test/SPCParent.java" />
				<include name="test/**/test/Pilot.java" />
				<include name="test/**/test/Car.java" />
				<include name="test/**/test/SimpleParentChild.java" />
				<include name="test/**/test/ReplicationEventTest.java" />
				<include name="test/**/test/ReplicationAfterDeletionTest.java" />
				<include name="test/**/test/SimpleArrayTest.java" />
				<include name="test/**/test/SimpleArrayHolder.java" />
				<include name="test/**/test/SimpleArrayContent.java" />
				<include name="test/**/test/ListTest.java" />
				<include name="test/**/test/ListHolder.java" />
				<include name="test/**/test/ListContent.java" />					
				<include name="test/**/test/Db4oListTest.java" />					
				<include name="test/**/test/R0to4Runner.java" />
				<include name="test/**/test/R0.java" />
				<include name="test/**/test/R0Linker.java" />
				<include name="test/**/test/R1.java" />
				<include name="test/**/test/R2.java" />
				<include name="test/**/test/R3.java" />
				<include name="test/**/test/R4.java" />
				<include name="test/**/test/ReplicationFeaturesMain.java" />
				<include name="test/**/test/Replicated.java" />				
				<include name="test/**/test/Person.java" />				
				<include name="test/**/test/Student.java" />				
		
				<include name="test/**/test/CollectionHolder.java" />
				<include name="test/**/test/MapHolder.java" />
				<include name="test/**/test/MapContent.java" />				
			
				<include name="test/**/test/foundation/*.java" />
                <include name="test/**/test/regression/*.java" />
				
				<exclude name="**/hibernate/**" />
				<exclude name="**/CollectionHandlerImplTest.java" />
				<exclude name="**/ReplicationTraversalTest.java" />
			</fileset>
		</copy>
	</target>

	<target name="select-dotnet-assembly" unless="mono">
		<property name="db4o.dll" value="${file.dll.net}" />
		<property name="db4ounit.dll" value="${file.dll.net.db4ounit}" />
		<property name="csc.executable.path.net2" location="${env.SystemRoot}/Microsoft.NET/Framework/v2.0.50727" />
		<property name="csc.executable" location="${csc.executable.path.net2}/csc.exe" />
	</target>
			
	<target name="select-mono-assembly" if="mono">	
		<property name="db4o.dll" value="${file.dll.net}" />
		<property name="db4ounit.dll" value="${file.dll.net.db4ounit}" />
		<property name="csc.executable" value="gmcs" />
	</target>
	
	<target name="select-db4o-assembly" depends="select-mono-assembly, select-dotnet-assembly">
	</target>
	
	<target name="init" depends="select-db4o-assembly">
        <delete dir="${drs.net.dir}" />
		<mkdir dir="${drs.net.dir}" />
		<mkdir dir="${drs.net.bin.dir}" />
		<copy file="${db4o.dll}" todir="${drs.net.bin.dir}" />
		<copy file="${db4ounit.dll}" todir="${drs.net.bin.dir}" />
		
		<copy file="${db4o.dll}" todir="${drsqs.net.bin.dir}" />
		<copy file="${db4ounit.dll}" todir="${drsqs.net.bin.dir}" />
		<mkdir dir="${drsqs.net.dir}" />
		<mkdir dir="${drsqs.net.bin.dir}" />
        
        <copy file="${drs.overlay.dir}/drs.sln" todir="${drs.net.dir}"/>
        <copy file="${drs.overlay.dir}/drs.suo" todir="${drs.net.dir}"/>
	</target>
    
    <target name="prepare-quickstart">
        <copy todir="${drs.net.dir}">
            <fileset dir="${drs.overlay.dir}">
                <include name="QuickStart/**/*" />
            </fileset>
        </copy>
        
    </target>
</project>