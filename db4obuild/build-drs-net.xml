<?xml version="1.0"?>
<project name="drs.net" default="rebuild">
	<import file="common.xml" />

	<property name="drs.dir" location="${dir.workspace}/drs" />
	<property name="drs.dll" location="${drs.dir}/drs.net/bin/drs.dll" />
	<property name="drs.src.dir" location="${drs.dir}/src" />
	<property name="drs.net.dir" location="${drs.dir}/drs.net" />
	<property name="drs.net.bin.dir" location="${drs.net.dir}/bin" />	
	<property name="drs.net.src.dir" location="${drs.net.dir}/drs/src" />
	<property name="drs.net.in.dir" location="${drs.net.dir}/in" />
	<property name="drs.net.tests.in.dir" location="${drs.net.dir}/drs.tests.in" />
	<property name="drs.conversion.workspace.dir" location="${dir.dist}/drs.net/workspace" />	
	<property name="drsqs.conversion.workspace.dir" location="${dir.dist}/drsquickstarts.net/workspace" />
	<property name="drsqs.dir" location="${dir.workspace}/drsquickstarts" />
	<property name="drsqs.src.dir" location="${drsqs.dir}/src" />
	<property name="drsqs.net.dir" location="${drsqs.dir}/quickstarts.net" />
	<property name="drsqs.net.in.dir" location="${drsqs.net.dir}/in" />	
	<property name="drsqs.net.src.dir" location="${drsqs.net.dir}/quickstarts/src" />
	<property name="drsqs.net.bin.dir" location="${drsqs.net.dir}/bin" />		
	
	<condition property="mono" value="1">
		<os family="unix" />
	</condition>

	<target name="rebuild" depends="reset-workspace, build" />
	
	<target name="build" depends="build-drs, update-quickstarts-project">
		
		<property name="drs.dll" location="${drs.net.bin.dir}/drs.dll" />
		
<!--		<csc outputfile="${drs.dll}"
			targettype="library"
			srcdir="${drs.net.src.dir}">
			<reference dir="${drs.net.bin.dir}">
				<include name="${file.name.dll}" />
			</reference>
		</csc> -->
	</target>

	<target name="build-drs" depends="update-csharp-projects">
		
		<property name="drs.dll" location="${drs.net.bin.dir}/drs.dll" />
		
		<csc outputfile="${drs.dll}"
			targettype="library"
			srcdir="${drs.net.src.dir}">
			<reference dir="${drs.net.bin.dir}">
				<include name="${file.name.dll}" />
			</reference>
		</csc>
	</target>
	
	<target name="create-jar-for-dependencies">
		<mkdir dir="${drs.conversion.workspace.dir}/lib" />
		<property name="dependencies.jar" location="${drs.conversion.workspace.dir}/lib/dependencies.jar" />
		<jar destfile="${dependencies.jar}">			
			<fileset dir="${dir.workspace}/db4oj/bin/">								
			</fileset>
			<fileset dir="${dir.workspace}/db4ojdk1.2/bin/">								
			</fileset>
			<fileset dir="${dir.workspace}/db4ojdk5/bin/">								
			</fileset>
			<fileset dir="${dir.workspace}/db4ounit/bin/">
			</fileset>
			<fileset dir="${dir.workspace}/db4ounit.extensions/bin/">
			</fileset>
			<fileset dir="${dir.workspace}/db4oj.tests/bin">
			</fileset>
		</jar>
	</target>

	<target name="create-jar-for-quickstart-dependencies">
		<mkdir dir="${drsqs.conversion.workspace.dir}/lib" />
		<property name="qsdependencies.jar" location="${drsqs.conversion.workspace.dir}/lib/dependencies.jar" />
		<jar destfile="${qsdependencies.jar}">			
			<fileset dir="${dir.workspace}/db4oj/bin/">								
			</fileset>
			<fileset dir="${dir.workspace}/drs/bin">
			</fileset>
		</jar>
	</target>

	<target name="sharpen-drs" depends="prepare-conversion-workspace, install-javatocsharp-plugin">
		<sharpen resource="drs/core" workspace="${drs.conversion.workspace.dir}">
			<args>
				<arg value="-cp" />
				<arg value="${dependencies.jar}" />
				
				<arg value="-srcfolder" />
				<arg value="test" />
				
				<arg value="-pascalcase" />
			
				<arg value="-nativeTypeSystem" />
				
				<arg value="-methodMapping" />
				<arg value="com.db4o.reflect.Reflector.forClass" />
				<arg value="com.db4o.drs.inside.ReplicationPlatform.ForType" />
				
				<arg value="-namespaceMapping" />
				<arg value="^db4ounit.extensions.fixtures" />
				<arg value="Db4oUnit.Extensions.Fixtures" />
				
				<arg value="-namespaceMapping" />
				<arg value="^db4ounit.extensions" />
				<arg value="Db4oUnit.Extensions" />
				
				<arg value="-namespaceMapping" />
				<arg value="^db4ounit" />
				<arg value="Db4oUnit" />
			</args>
		</sharpen>
	</target>

	<target name="sharpen-quickstarts" depends="sharpen-drs, prepare-quickstarts-conversion-workspace, install-javatocsharp-plugin">
		<sharpen resource="drsquickstarts/core" workspace="${drsqs.conversion.workspace.dir}">
			<args>
				<arg value="-cp" />
				<arg value="${qsdependencies.jar}" />
				
				<arg value="-pascalcase" />
			
				<arg value="-nativeTypeSystem" />
				
				<arg value="-methodMapping" />
				<arg value="com.db4o.reflect.Reflector.forClass" />
				<arg value="com.db4o.drs.inside.ReplicationPlatform.ForType" />
				
			</args>
		</sharpen>
	</target>

	<target name="test" depends="update-csharp-projects">
		
		<csc srcdir="${dir.n}/Db4oUnit/src"
			targettype="library"
			destfile="${drs.net.bin.dir}/Db4oUnit.dll">
		</csc>
		
		<csc srcdir="${dir.n}/Db4oUnit.Extensions/src"
			targettype="library"
			destfile="${drs.net.bin.dir}/Db4oUnit.Extensions.dll">
			<reference dir="${drs.net.bin.dir}">
				<include name="*.dll" />
				<exclude name="Db4oUnit.Extensions.dll" />
			</reference>
		</csc>
		
		<csc srcdir="${drs.net.dir}/drs.tests"
			targettype="exe"
			destfile="${drs.net.bin.dir}/drs.tests.exe"
			mainclass="drs.tests.Program">
			<reference dir="${drs.net.bin.dir}">
				<include name="*.dll" />
			</reference>
		</csc>
		
		<exec executable="mono" dir="${drs.net.bin.dir}">
			<arg value="--debug"/>
			<arg file="${drs.net.bin.dir}/drs.tests.exe" />
		</exec>
	</target>
	
	<target name="update-drs-project" depends="sharpen-drs">
		<delete dir="${drs.net.src.dir}" />
		<mkdir dir="${drs.net.src.dir}" />
		<copy todir="${drs.net.src.dir}">
			<fileset dir="${drs.conversion.workspace.dir}/drscsharp/src">
				<include name="**/*.cs" />
				<exclude name="**/test/**" />
			</fileset>
		</copy>

		<copy todir="${drs.net.src.dir}" overwrite="true">
			<fileset dir="${drs.net.in.dir}">
				<include name="**/*.cs" />
			</fileset>
		</copy>
		
		<updatecsharpproject projectfile="${drs.net.dir}/drs/drs.csproj">
			<sources dir="${drs.net.dir}/drs">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject>
	</target>
	
	<target name="update-drs.tests-project" depends="sharpen-drs">
		<copy todir="${drs.net.dir}/drs.tests/src">
			<fileset dir="${drs.conversion.workspace.dir}/drscsharp/src">
				<include name="**/test/**" />
			</fileset>
		</copy>

		<copy todir="${drs.net.dir}/drs.tests/src" overwrite="true">
			<fileset dir="${drs.net.tests.in.dir}">
				<include name="**/*.cs" />
			</fileset>
		</copy>

		<updatecsharpproject projectfile="${drs.net.dir}/drs.tests/drs.tests.csproj">
			<sources dir="${drs.net.dir}/drs.tests">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject>
	</target>

	<target name="update-quickstarts-project" depends="sharpen-quickstarts">
		<delete dir="${drsqs.net.src.dir}" />
		<mkdir dir="${drsqs.net.src.dir}" />
		
		<copy file="${drs.dll}" todir="${drsqs.net.bin.dir}" />
			
		<copy todir="${drsqs.net.src.dir}">
			<fileset dir="${drsqs.conversion.workspace.dir}/drsquickstartscsharp/src">
				<include name="**/*.cs" />
			</fileset>
		</copy>

		<copy todir="${drsqs.net.src.dir}" overwrite="true">
			<fileset dir="${drsqs.net.in.dir}">
				<include name="**/*.cs" />
			</fileset>
		</copy>
		
<!--		<updatecsharpproject projectfile="${drsqs.net.dir}/drs/drs.csproj">
			<sources dir="${drs.net.dir}/drs">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject> -->
	</target>

	<target name="update-csharp-projects" depends="update-drs-project, update-drs.tests-project">				
	</target>
	
	<target name="reset-workspace" depends="init">
		<delete dir="${drs.conversion.workspace.dir}" />
		<mkdir dir="${drs.conversion.workspace.dir}" />
	</target>

	<target name="reset-drsqs-workspace" depends="init">
		<delete dir="${drsqs.conversion.workspace.dir}" />
		<mkdir dir="${drsqs.conversion.workspace.dir}" />
	</target>

	<target name="prepare-conversion-workspace" depends="create-jar-for-dependencies">
		<copy todir="${drs.conversion.workspace.dir}/drs">
			<fileset dir="${drs.src.dir}">
				<include name="core/**/*.java" />
				<include name="test/**/test/Db4oClientServerDrsFixture.java" />
				<include name="test/**/test/Db4oDrsFixture.java" />
				<include name="test/**/test/Db4oTests.java" />
				<include name="test/**/test/DrsFixture.java" />				
				<include name="test/**/test/DrsTestCase.java" />
				<include name="test/**/test/DrsTestSuite.java" />
				<include name="test/**/test/DrsTestSuiteBuilder.java" />					
				<include name="test/**/test/ReplicationProviderTest.java" />
				<include name="test/**/test/GetByUUID.java" />
				<include name="test/**/test/TheSimplest.java" />
				<include name="test/**/test/SPCChild.java" />
				<include name="test/**/test/SPCParent.java" />
				<include name="test/**/test/Pilot.java" />
				<include name="test/**/test/Car.java" />
				<include name="test/**/test/SimpleParentChild.java" />
				<include name="test/**/test/ReplicationEventTest.java" />
				<include name="test/**/test/ReplicationAfterDeletionTest.java" />
				<include name="test/**/test/SimpleArrayTest.java" />
				<include name="test/**/test/SimpleArrayHolder.java" />
				<include name="test/**/test/SimpleArrayContent.java" />
				<include name="test/**/test/ListTest.java" />
				<include name="test/**/test/ListHolder.java" />
				<include name="test/**/test/ListContent.java" />					
				<include name="test/**/test/Db4oListTest.java" />					
				<include name="test/**/test/R0to4Runner.java" />
				<include name="test/**/test/R0.java" />
				<include name="test/**/test/R0Linker.java" />
				<include name="test/**/test/R1.java" />
				<include name="test/**/test/R2.java" />
				<include name="test/**/test/R3.java" />
				<include name="test/**/test/R4.java" />
				<include name="test/**/test/ReplicationFeaturesMain.java" />
				<include name="test/**/test/Replicated.java" />				
				<include name="test/**/test/Person.java" />				
				<include name="test/**/test/Student.java" />				
				<include name="test/**/test/InheritanceTest.java" />				
				<include name="test/**/test/CollectionHolder.java" />
				<include name="test/**/test/MapHolder.java" />
				<include name="test/**/test/MapContent.java" />				
				
				<exclude name="**/hibernate/**" />
				<exclude name="**/VectorFlattener.java" />
			</fileset>
		</copy>
	</target>

	<target name="prepare-quickstarts-conversion-workspace" depends="reset-drsqs-workspace, create-jar-for-quickstart-dependencies">
		<copy todir="${drsqs.conversion.workspace.dir}/drsquickstarts/core">
			<fileset dir="${drsqs.src.dir}">
				<include name="**/*.java" />
			</fileset>
		</copy>
	</target>

	<target name="select-dotnet-assembly" unless="mono">
		<property name="db4o.dll" value="${file.dll.net}" />
	</target>
			
	<target name="select-mono-assembly" if="mono">	
		<property name="db4o.dll" value="${file.dll.mono}" />
	</target>
	
	<target name="select-db4o-assembly" depends="select-mono-assembly, select-dotnet-assembly">
	</target>
	
	<target name="init" depends="select-db4o-assembly">
		<mkdir dir="${drs.net.dir}" />
		<mkdir dir="${drs.net.bin.dir}" />
		<copy file="${db4o.dll}" todir="${drs.net.bin.dir}" />
		<copy file="${db4o.dll}" todir="${drsqs.net.bin.dir}" />
		<mkdir dir="${drsqs.net.dir}" />
		<mkdir dir="${drsqs.net.bin.dir}" />
	</target>
</project>