<?xml version="1.0"?>
<project name="common build definitions">
	<property environment="env" />
	<property name="path.machine.properties" value="machine.properties" />
	<property file="${path.machine.properties}" />
	<property file="ant.properties" />
	
	<taskdef name="doctor" classname="com.yetac.doctor.Doctor">
		<classpath>
			<pathelement location="${dir.dist.classes.java1.2}" />
			<pathelement location="${dir.doctor.bin}" />
			<pathelement location="${dir.doctor.lib}/iText.jar" />
			<pathelement location="${dir.dist.classes.tutorial}" />
			<pathelement location="${dir.dist.classes.reference}" />
			<pathelement location="${dir.dist.classes.nqopt}" />
			<pathelement location="${file.bloat.jar}" />
		</classpath>
	</taskdef>

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${dir.build.lib}/antcontrib/ant-contrib.jar" />
		</classpath>
	</taskdef>
	
	<taskdef name="svnRevision" classname="com.db4o.devtools.ant.SvnRevision">
		<classpath>
			<pathelement location="${dir.build.bin}" />
			<pathelement location="${dir.build.lib}/svnkit/svnkit.jar" />
			<path path="${path.classpath.full}" />
		</classpath>
	</taskdef>
	
	<taskdef name="filehead" classname="com.db4o.devtools.ant.FileHeadAntTask">
		<classpath>
			<pathelement location="${dir.build.bin}" />
			<path path="${path.classpath.full}" />
		</classpath>
	</taskdef>
	
	<taskdef name="updatecsharpproject" classname="com.db4o.devtools.ant.UpdateCSharpProjectAntTask">
		<classpath>
			<pathelement location="${dir.build.bin}" />
			<path path="${path.classpath.full}" />
		</classpath>
	</taskdef>
	
	<taskdef name="updateAssemblyHintPath" classname="com.db4o.devtools.ant.UpdateAssemblyHintPath">
		<classpath>
			<pathelement location="${dir.build.bin}" />
			<path path="${path.classpath.full}" />
		</classpath>
	</taskdef>
	
	<taskdef name="updateAssemblyInfo" classname="com.db4o.devtools.ant.UpdateAssemblyInfoTask">
		<classpath>
			<pathelement location="${dir.build.bin}" />
			<path path="${path.classpath.full}" />
		</classpath>
	</taskdef>

	
	<taskdef name="versioninfo" classname="com.db4o.devtools.ant.VersionInfoAntTask" classpath="${dir.build.lib}/exttools.jar">
		<classpath>
			<pathelement location="${dir.build.lib}/exttools.jar" />
			<pathelement location="${dir.build.bin}" />
			<path path="${path.classpath.full}" />
		</classpath>
	</taskdef>
	
	<taskdef name="assemblykey" classname="com.db4o.devtools.ant.UpdateAssemblyKeyTask" classpath="${dir.build.lib}/exttools.jar">
		<classpath>
			<pathelement location="${dir.build.lib}/exttools.jar" />
			<pathelement location="${dir.build.bin}" />
			<path path="${path.classpath.full}" />
		</classpath>
	</taskdef>
	
	<property name="eclipse.startup.jar" location="${eclipse.home}/startup.jar" />
	
	<macrodef name="sharpen">
		<attribute name="workspace" />
		<attribute name="resource" />
		
		<element name="args" optional="yes" />
		
		<sequential>
			<exec executable="${file.jvm.jdk1.5}" failonerror="true" timeout="1800000">
				<arg value="-Xmx512m" />
				<arg value="-cp" />
				<arg value="${eclipse.startup.jar}" />
				<arg value="org.eclipse.core.launcher.Main" />
				<arg value="-data" />
				<arg file="@{workspace}" />
				<arg value="-application" />
				<arg value="javatocsharp.core.application" />
				<arg value="-header" />
				<arg file="${dir.config}/copyright_comment.txt" />
				<arg value="@{resource}" />
				
				<args />
				
			</exec>
		</sequential>
	</macrodef>
	
	<macrodef name="updateAssemblyInfoFiles">
		<attribute name="srcdir" />
		<sequential>
			<updateAssemblyInfo version="${db4o.version.full}">
				<fileset dir="@{srcdir}">
					<include name="**/AssemblyInfo.cs" />
				</fileset>
			</updateAssemblyInfo>
		</sequential>
	</macrodef>

	
	<target name="install-javatocsharp-plugin">
			
		<property name="javatocsharp.core.dir" location="../javatocsharp.core" />
		
		<mkdir dir="${javatocsharp.core.dir}/bin" />
		
		<echo>${eclipse.home}/plugins</echo>
		<javac fork="true" debug="true" source="1.5" destdir="${javatocsharp.core.dir}/bin" srcdir="${javatocsharp.core.dir}/src" encoding="UTF-8">
			<classpath>
				<fileset dir="${eclipse.home}/plugins">
					<include name="org.eclipse.osgi_*/osgi.jar" />
					<include name="org.eclipse.core.resources_*/resources.jar" />
					<include name="org.eclipse.core.runtime_*/runtime.jar" />
					<include name="org.eclipse.jdt.core_*/jdtcore.jar" />
					<!-- redundant entries: in newer eclipse installs those reside in jars -->
					<include name="org.eclipse.osgi_*.jar" />
					<include name="org.eclipse.core.resources_*.jar" />
					<include name="org.eclipse.core.runtime_*.jar" />
					<include name="org.eclipse.jdt.core_*.jar" />
					<include name="org.eclipse.jdt.launching_*.jar" />
					<include name="org.eclipse.equinox.common_*.jar" />
					<include name="org.eclipse.core.jobs_*.jar" />
				</fileset>
			</classpath>
		</javac>
		
		<property name="plugin.dir" value="${plugins.home}/javatocsharp.core_1.0.0" />
		<delete dir="${plugin.dir}" />
		<mkdir dir="${plugin.dir}" />
		<jar destfile="${plugin.dir}/javatocsharp.jar" basedir="${javatocsharp.core.dir}/bin" />
		<copy todir="${plugin.dir}" file="${javatocsharp.core.dir}/plugin.xml" />

	</target>
	
	<target name="get-svn-revision" unless="svn.revision">
		<svnRevision property="svn.revision" />
		<echo>Revision: ${svn.revision}</echo>
	</target>

	
	<if>
		<equals arg1="${compiledll.debug}" arg2="true" />
		<then>
			<property name="compiledll.debug.symbol" value="+" />
		</then>
		<else>
			<property name="compiledll.debug.symbol" value="-" />
		</else>
	</if>
	
	<macrodef name="reset-dir">
		<attribute name="dir" />
		<sequential>
			<delete dir="@{dir}" />
			<mkdir dir="@{dir}" />
		</sequential>
	</macrodef>

	<target name="properties" depends="get-svn-revision">
		<tstamp>
			<format property="db4o.iteration" pattern="w" offset="-29" unit="week"/>
		</tstamp>		
		<property name="db4o.file" value="db4o-${db4o.version.dotted}.${db4o.iteration}.${svn.revision}-" />
		
		<property name="file.java1.1.jar" value="${dir.dist.jars}/${db4o.file}java1.1.jar" />
		<property name="file.java1.2.jar" value="${dir.dist.jars}/${db4o.file}java1.2.jar" />
		<property name="file.java5.jar" value="${dir.dist.jars}/${db4o.file}java5.jar" />
		<property name="file.osgi.jar" value="${dir.dist.jars}/${db4o.file}osgi.jar" />
		<property name="file.osgi.test.jar" value="${dir.dist.jars}/${db4o.file}osgi-test.jar" />
		<property name="file.sharp.jar" value="${dir.dist.jars}/${db4o.file}sharp.jar" />
		<property name="file.db4otools.jar" value="${dir.dist.jars}/${db4o.file}tools.jar" />
		<property name="file.nqopt.jar" value="${dir.dist.jars}/${db4o.file}nqopt.jar" />
		<property name="file.db4ounit.jar" value="${dir.dist.jars}/${db4o.file}db4ounit.jar" />
		<property name="file.ta.jar" value="${dir.dist.jars}/${db4o.file}ta.jar" />
		<property name="file.java.test.src.zip" value="${dir.dist.java}/${db4o.file}test.zip" />
		<property name="file.dist.java" value="${dir.dist}/${db4o.file}java.zip" />
	</target>

</project>