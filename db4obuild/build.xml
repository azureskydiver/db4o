<?xml version="1.0"?>
<project name="db4obuild" default="buildall" basedir=".">

<!--
	Depends on a custom local file 'machine.properties' with
	the following entries:

	dir.workspace=<the workspace folder where all projects reside>
	file.compiler.jdk1.3=<path to jdk 1.3 java compiler>
	file.jvm.jdk1.5=<path to jdk 1.5 java vm executable>
	font.pdf.base=<true type font>
	dir.compactframework=<path to the 2.0 version of the compact framework, leave empty if not available>
	eclipse.home=<eclipse home dir>
	csc.executable.path.net2=<path to csc.exe for .NET 2.0 if different than default>
	file.compiler.jdk1.3.args.optional=<OPTIONAL: any parameters for javac, e.g. '-source 1.3' if a JDK >= 5 is used>
	file.keystore=<OPTIONAL: keystore location for signjar tasks. if not present, ${user.home}/.keystore is assumed>	
	mono.mcs.executable=<OPTIONAL: path to mcs executable, overrides ant.properties entry>
	mono.gmcs.executable=<OPTIONAL: path to gmcs executable, overrides ant.properties entry>
	
	An example:
	dir.workspace=C:/_db4o/production
	file.compiler.jdk1.3=C:/jdk1.3.1_12/bin/javac.exe
	file.jvm.jdk1.5=/usr/java/jdk1.5.0_03.32bit/bin/java
	font.pdf.base=C:/WINDOWS/Fonts/VERDANA.TTF
	dir.compactframework=C:/Arquivos de programas/Microsoft Visual Studio 8/SmartDevices/SDK/CompactFramework/2.0/
	eclipse.home=c:/Program Files/Eclipse	
	csc.executable.path.net2=C:/WINDOWS/Microsoft.NET/Framework/v2.0.50727/
-->
	<import file="common.xml" />

	<target name="init" description="Basic initialization">
		<tstamp />
		<mkdir dir="${dir.dist}" />
		<mkdir dir="${dir.dist.jars}" />
		<mkdir dir="${dir.sharpen}" />
		<mkdir dir="${dir.dist.net.build.src}" />
		<mkdir dir="${dir.dist.net.instrumentation}" />
		<mkdir dir="${dir.dist.mono.build.src}" />
		<mkdir dir="${dir.dist.doctor}" />
		<mkdir dir="${dir.dist.doc.api}" />
		<mkdir dir="${dir.dist.java.build.tutorial}" />
		<mkdir dir="${dir.dist.java.build.tutorial.src}" />
		<mkdir dir="${dir.dist.dll.net}" />
		<mkdir dir="${dir.dist.dll.compact}" />
		<mkdir dir="${dir.dist.dll.mono}" />
		<loadfile property="content.gplheader" srcfile="${file.gplheader}" encoding="iso-8859-1" />
		<loadfile property="content.copyrightheader" srcfile="${file.copyrightheader}" encoding="iso-8859-1" />
		<versioninfo path="${dir.j.core.src}/com/db4o" java="true" version="${db4o.version.full}" major="${db4o.version.major}" minor="${db4o.version.minor}" />
		<versioninfo path="${dir.n.core.src}/net" net="true" keyfile="" version="${db4o.version.full}" major="${db4o.version.major}" minor="${db4o.version.minor}"/>
		<versioninfo path="${dir.n.core.src}/compact" compact="true" keyfile="" version="${db4o.version.full}" major="${db4o.version.major}"  minor="${db4o.version.minor}"/>
		<property name="file.compiler.jdk1.3.args.optional" value="" />
	</target>

	<target name="clean" description="Delete all generated files">
		<delete failonerror="false" includeemptydirs="true" description="Removing all generated files">
			<fileset dir="${dir.sharpen}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${dir.dist}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${dir.j.tutorial.out.java}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${dir.j.tutorial.out.net}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${dir.j.tutorial.out.mono}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${dir.j.reference.out.java}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${dir.n.core.src}">
				<include name="**/*.cs" />
			</fileset>
			<fileset dir="${dir.build}">
				<include name="*.yap" />
			</fileset>
		</delete>
		<ant dir="${dir.n.tutorial}" target="clean"/>
	</target>
	
	<target name="filehead" depends="init" description="Add copyright header to all input sources">
		<filehead beforePattern="package" header="${content.copyrightheader}" >
			<sources dir="${dir.j}">
				<include name="**/*.java" />
			</sources>
		</filehead>
		<filehead beforePattern="package" header="${content.copyrightheader}" >
			<sources dir="${dir.doctor.src}">
				<include name="**/*.java" />
			</sources>
		</filehead>
		<filehead beforePattern="package" header="${content.copyrightheader}" >
			<sources dir="${dir.n.in.java}">
				<include name="**/*.java" />
			</sources>
		</filehead>
		<filehead beforePattern="using|namespace"  header="${content.copyrightheader}" >
			<sources dir="${dir.n.in.sharp}">
				<include name="**/*.cs" />
			</sources>
		</filehead>
		<filehead beforePattern="using|namespace"  header="${content.copyrightheader}" >
			<sources dir="${dir.n.core}">
				<include name="**/*.cs" />
			</sources>
		</filehead>
		<filehead beforePattern="using|namespace"  header="${content.copyrightheader}" >
			<sources dir="${dir.n.test}">
				<include name="**/*.cs" />
			</sources>
		</filehead>
		<filehead beforePattern="using|namespace"  header="${content.copyrightheader}" >
			<sources dir="${dir.n.tools}">
				<include name="**/*.cs" />
				<exclude name="Libs/**/*.*" />
			</sources>
		</filehead>
	</target>

	<target name="copyjava1.1">
		<mkdir dir="${dir.dist.java.temp.src.core}" />
		<delete>
			<fileset dir="${dir.dist.java.temp.src.core}">
				<include name="**/*"/>
			</fileset>
		</delete>
		<copy todir="${dir.dist.java.temp.src.core}" overwrite="true">
			<fileset dir="${dir.j.core.src}">
				<include name="**/*.java" />
			</fileset>
		</copy>		
	</target>

	<target name="copyjava1.2" depends="copyjava1.1">
		<copy todir="${dir.dist.java.temp.src.core}" overwrite="true">
			<fileset dir="${dir.j.jdk1.2.core.src}">
				<include name="**/*.java" />
			</fileset>
		</copy>
	</target>

	<target name="copyjava5" depends="copyjava1.2">
		<copy todir="${dir.dist.java.temp.src.core}" overwrite="true">
			<fileset dir="${dir.j.jdk5.core.src}">
				<include name="**/*.java" />
			</fileset>
		</copy>
	</target>

	<target name="compilecorejava" depends="init" description="Compile Db4o core sources">
		<mkdir dir="${dir.dist.classes.java1.1}" />
		<delete>
			<fileset dir="${dir.dist.classes.java1.1}">
				<include name="**/*"/>
			</fileset>
		</delete>
		<antcall target="copyjava1.1" />
		<javac compiler="classic"
			fork="yes"
			executable="${file.compiler.jdk1.3}"
			srcdir="${dir.dist.java.temp.src.core}"
			destdir="${dir.dist.classes.java1.1}" debug="off">
			<compilerarg line="${file.compiler.jdk1.3.args} ${file.compiler.jdk1.3.args.optional}"/>
		</javac>

		<mkdir dir="${dir.dist.classes.java1.2}" />
		<delete>
			<fileset dir="${dir.dist.classes.java1.2}">
				<include name="**/*"/>
			</fileset>
		</delete>
		<antcall target="copyjava1.2" />
		<javac srcdir="${dir.dist.java.temp.src.core}" fork="true" destdir="${dir.dist.classes.java1.2}" debug="off" target="1.2" source="1.2" encoding="UTF-8" />

		<mkdir dir="${dir.dist.classes.java5}" />
		<delete>
			<fileset dir="${dir.dist.classes.java5}">
				<include name="**/*"/>
			</fileset>
		</delete>
		<antcall target="copyjava5" />
		<javac srcdir="${dir.dist.java.temp.src.core}" fork="true" destdir="${dir.dist.classes.java5}" debug="off" target="1.5" source="1.5" encoding="UTF-8" />

		<jar destfile="${file.java1.1.jar}">
			<fileset dir="${dir.dist.classes.java1.1}" />
		</jar>
		<jar destfile="${file.java1.2.jar}">
			<fileset dir="${dir.dist.classes.java1.2}" />
		</jar>
		<jar destfile="${file.java5.jar}">
			<fileset dir="${dir.dist.classes.java5}" />
		</jar>
		
		<mkdir dir="${dir.dist.classes.nqopt}" />
		<delete>
			<fileset dir="${dir.dist.classes.nqopt}">
				<include name="**/*"/>
			</fileset>
		</delete>
		<javac srcdir="${dir.j.nqopt.src}" fork="true" destdir="${dir.dist.classes.nqopt}" debug="off" target="1.2" source="1.2" encoding="UTF-8">
			<exclude name="**/j2me/**"/>
			<classpath>
				<pathelement path="${file.java1.2.jar}"/>
				<pathelement path="${file.bloat.jar}"/>
				<pathelement path="${file.ant.jar}"/>
			</classpath>
		</javac>
		<jar destfile="${file.nqopt.jar}">
			<fileset dir="${dir.dist.classes.nqopt}" />
			<manifest>
				<attribute name="Class-Path" value="${filename.bloat.jar} ${filename.ant.jar} ${filename.java1.2.jar}"/>
			</manifest>
		</jar>
		<copy file="${file.bloat.jar}" todir="${dir.dist.jars}" />
		<copy file="${file.ant.jar}" todir="${dir.dist.jars}" />
		<copy file="${file.bloat.license}" todir="${dir.dist.jars}" />
		<copy file="${file.ant.license}" todir="${dir.dist.jars}" />
		<copy file="${file.3rdpartylibs.java}" todir="${dir.dist.jars}" />
	</target>

	<target name="compileobjectmanager" depends="compilecorejava" description="Compile object manager sources">
		<mkdir dir="${dir.dist.classes.objectmanager}" />
		<delete>
			<fileset dir="${dir.dist.classes.objectmanager}">
				<include name="**/*" />
			</fileset>
			<fileset dir="${dir.objectmanager.lib}">
				<include name="db4o-*.jar" />
			</fileset>
		</delete>
		<copy file="${file.java1.2.jar}" todir="${dir.objectmanager.lib}" />
		<depend srcdir="${dir.objectmanager.src}" destdir="${dir.dist.classes.objectmanager}" closure="yes" />
		<javac srcdir="${dir.objectmanager.src}" destdir="${dir.dist.classes.objectmanager}" fork="true" debug="off" target="1.3" source="1.3" encoding="UTF-8">
				<include name="**/*.java" />
				<exclude name="**/*test/*" />
				<exclude name="**/*Test.java" />
				<exclude name="**/eclipse/**" />
				<exclude name="**/editors/**" />
				<exclude name="**/BrowserPlugin.java" />
				<exclude name="**/TestStarter.java" />
				<exclude name="**/rcp/*" />
			<classpath>
				<fileset dir="${dir.objectmanager.lib}">
					<include name="linux/*.jar" />
					<include name="*.jar" />
				</fileset>
			</classpath>
		</javac>
		<delete file="${file.objectmanager.jar}" failonerror="false" quiet="true" />
		<jar destfile="${file.objectmanager.jar}">
			<fileset dir="${dir.dist.classes.objectmanager}" />
			<fileset dir="${dir.objectmanager.src}">
				<include name="**/*.xswt" />
				<include name="**/*.gif" />
				<include name="**/*.jpg" />
				<include name="**/*.jpeg" />
		    </fileset>
		</jar>
	</target>

	<target name="cleanomscripttempdir">
		<mkdir dir="${dir.objectmanager.scripts.temp}" />
		<delete>
			<fileset dir="${dir.objectmanager.scripts.temp}">
				<include name="*" />
			</fileset>
		</delete>
	</target>
	
	<target name="zipobjectmanager" depends="compileobjectmanager">		
		<delete file="${file.objectmanager.linux.archive}" quiet="true" failonerror="false" />
		<zip destfile="${file.objectmanager.linux.archive}" basedir="${dir.objectmanager.launcher}">
			<include name="lib/*" />
			<include name="lib/licenses/*" />
			<include name="lib/linux/*" />
		</zip>
		<antcall target="cleanomscripttempdir" />
		<copy file="${dir.objectmanager.scripts}/linux/objectmanager.sh" todir="${dir.objectmanager.scripts.temp}">
			<filterset>
				<filter token="db4oversion" value="${db4o.version.dotted}"/>
				<filter token="omversion" value="${objectmanager.version.dotted}"/>
			</filterset>
		</copy>
		<zip destfile="${file.objectmanager.linux.archive}" basedir="${dir.objectmanager.scripts.temp}" update="true">
			<include name="objectmanager.sh" />
		</zip>

		<delete file="${file.objectmanager.windows.archive}" quiet="true" failonerror="false" />
		<zip destfile="${file.objectmanager.windows.archive}" basedir="${dir.objectmanager.launcher}">
			<include name="lib/*" />
			<include name="lib/licenses/*" />
			<include name="lib/windows/*" />
		</zip>
		<antcall target="cleanomscripttempdir" />
		<copy file="${dir.objectmanager.scripts}/win_novm/objectmanager.bat" todir="${dir.objectmanager.scripts.temp}">
			<filterset>
				<filter token="db4oversion" value="${db4o.version.dotted}"/>
				<filter token="omversion" value="${objectmanager.version.dotted}"/>
			</filterset>
		</copy>
		<zip destfile="${file.objectmanager.windows.archive}" basedir="${dir.objectmanager.scripts.temp}" update="true">
			<include name="objectmanager.bat" />
		</zip>

		<delete file="${file.objectmanager.win_ikvm.archive}" quiet="true" failonerror="false" />
		<zip destfile="${file.objectmanager.win_ikvm.archive}" basedir="${dir.objectmanager.launcher}">
			<include name="lib/*" />
			<include name="ikvm/**" />
			<include name="lib/licenses/*" />
			<include name="lib/windows/*" />
		</zip>
		<antcall target="cleanomscripttempdir" />
		<copy file="${dir.objectmanager.scripts}/win_ikvm/objectmanager.bat" todir="${dir.objectmanager.scripts.temp}">
			<filterset>
				<filter token="db4oversion" value="${db4o.version.dotted}"/>
				<filter token="omversion" value="${objectmanager.version.dotted}"/>
			</filterset>
		</copy>
		<zip destfile="${file.objectmanager.win_ikvm.archive}" basedir="${dir.objectmanager.scripts.temp}" update="true">
			<include name="*.bat" />
		</zip>
	</target>
	
	<target name="compilebuild" depends="init" description="Compile Db4o build sources">
		<mkdir dir="${dir.build.bin}" />
		<depend srcdir="${dir.build.src}" destdir="${dir.build.bin}" closure="yes" />
		<javac srcdir="${dir.build.src}" destdir="${dir.build.bin}" debug="off" fork="true" target="1.3" source="1.3" encoding="UTF-8">
			<classpath path="${path.classpath.full}" />
		</javac>
		<copy todir="${dir.build.bin}">
			<fileset dir="${dir.build.src}" includes="**/*.properties"/>
		</copy>
	</target>
	
	<target name="compilecoredll-net">
		<versioninfo path="${dir.n.core.src}/net" net="true" keyfile="${filename.keyfile}" version="${db4o.version.full}" major="${db4o.version.major}"  minor="${db4o.version.minor}"/>
		<csc
			srcdir="${dir.n.core.src}"
			targettype="library"
			destfile="${file.dll.net}"
			docfile="${file.xml.net}"
			debug="${compiledll.debug}"
			warnlevel="0"
			optimize="true"
			failonerror="true"
			definitions="${csharp.defines}"
			executable="${csc.executable}">
			
			<include name="*.cs" />
			<exclude name="compact/**" />
		</csc>
	</target>
	

	
	<target name="compilecoredll-compact">
		<delete dir="${dir.dist.net.compile}" />
		<copy todir="${dir.dist.net.compile}">
			<fileset dir="${dir.n.core.src}">
				<include name="**/*.cs" />
				<exclude name="net/**" />
			</fileset>
		</copy>
		<versioninfo path="${dir.dist.net.compile}/compact" compact="true" keyfile="${filename.keyfile}" version="${db4o.version.full}" major="${db4o.version.major}"  minor="${db4o.version.minor}"/>
		<copy file="${file.keypair}" todir="${dir.dist.net.compile}" />		
		<mkdir dir="${dir.dist.dll.compact}" />
		<exec executable="${csc.executable}" dir="${dir.dist.net.compile}" failonerror="true">
			<arg value="/optimize" />
			<arg value="/debug${compiledll.debug.symbol}" />
			<arg value="/define:${csharp.defines.cf}" />
			<arg value="/out:${file.dll.compact}" />
			<arg value="/doc:${file.xml.compact}" />
			<arg value="/target:library" />
			<arg value="/warn:1" />
			<arg value="/noconfig" />
			<arg value="/nostdlib" />
			<arg value="/r:${dir.dll.wince}mscorlib.dll" />
			<arg value="/r:${dir.dll.wince}System.dll" />
			<arg value="/recurse:*.cs" />
		</exec>
	</target>
	
	<target name="compiletools-net" depends="copy-tools-sources">		
		<csc srcdir="${dir.dist.net.compile}"
			targettype="library"
			destfile="${file.dll.tools.net}"
			debug="${compiledll.debug}"
			executable="${csc.executable}"
			definitions="NET">
			
			<reference dir="${dir.dist.dll.net}">
				<include name="${file.name.dll}" />
			</reference>
		</csc>
	</target>
		
	<target name="compiletools-compact" depends="copy-tools-sources">
		<exec executable="${csc.executable}" dir="${dir.dist.net.compile}" failonerror="true">
			<arg value="/optimize" />
			<arg value="/debug${compiledll.debug.symbol}" />
			<arg value="/define:${csharp.defines.cf}" />
			<arg value="/out:${file.dll.tools.compact}" />
			<arg value="/target:library" />
			<arg value="/warn:1" />
			<arg value="/noconfig" />
			<arg value="/nostdlib" />
			<arg value="/r:${dir.dll.wince}mscorlib.dll" />
			<arg value="/r:${dir.dll.wince}System.dll" />
			<arg value="/r:${file.dll.compact}" />
			<arg value="/recurse:*.cs" />
		</exec>
	</target>
	
	<target name="compiledllnet" depends="init, sharpen">
		
		<antcall target="compilecoredll-net">
			<param name="src.dir" value="${dir.n.core.src}" />
		</antcall>
		<!-- <antcall target="compiletools-net" /> -->
		<antcall target="compilecoredll-compact">
			<param name="src.dir" value="${dir.n.core.src}" />
		</antcall>
		<!-- <antcall target="compiletools-compact" /> -->
	</target>
	
	<target name="copy-tools-sources">
		<delete dir="${dir.dist.net.compile}" />
		<copy todir="${dir.dist.net.compile}">
			<fileset dir="${dir.n.tools}">
				<include name="**/*.cs" />
				<exclude name="Libs/**/AssemblyInfo.cs" />
				<exclude name="Libs/Mono.Cecil/CodeGen/**/*.*" />
				<exclude name="Libs/Cecil.FlowAnalysis/codegen/**/*.*" />
				<exclude name="Libs/Cecil.FlowAnalysis/Cecil.FlowAnalysis.Tests/**/*.*" />
			</fileset>
		</copy>
		<copy file="${file.keypair}" todir="${dir.dist.net.compile}" />
		<assemblykey keyfile="${dir.dist.net.compile}/${filename.keyfile}" assemblyinfo="${dir.dist.net.compile}/AssemblyInfo.cs" />
		<updateAssemblyInfoFiles srcdir="${dir.dist.net.compile}" />
	</target>
	
	<target name="runtestsnet" depends="configure-net1.1, compiletestsnet">
		<exec executable="${dir.dist.dll.net}/db4o-net-test.exe" dir="${dir.dist.dll.net}">
		</exec>
	</target>
	
	<target name="compiletestsnet" depends="compiledllnet">	
		<csc srcdir="${dir.n.test}/src"
			targettype="exe"
			destfile="${dir.dist.dll.net}/db4o-net-test.exe"
			debug="true"
			mainclass="com.db4o.test.AllTests"
			definitions="NET">
			
			<exclude name="compact*/**" />
			
			<reference dir="${dir.dist.dll.net}">
				<include name="${file.name.dll}" />
				<include name="${file.name.tools.dll}" />
				<include name="System.Drawing.dll" />
			</reference>
		</csc>
	</target>
	
	<target name="do-compiletoolsmono">
		<updateAssemblyInfo version="${db4o.version.full}">
			<fileset dir="${src.dir}">
				<include name="AssemblyInfo.cs" />
			</fileset>
		</updateAssemblyInfo>
		<csc srcdir="${src.dir}"
			targettype="library"
			destfile="${file.dll.tools.mono}"
			debug="true"
			executable="${mono.executable}"
			definitions="${mono.definitions}">
			
			<exclude name="compact*/**" />
			<exclude name="**/templates/**" />
			<exclude name="**/Cecil.FlowAnalysis.Tests/**" />
			<exclude name="**/Cecil.FlowAnalysis/AssemblyInfo.cs" />
			<exclude name="**/Mono.Cecil/AssemblyInfo.cs" />

			<reference dir="${dir.dist.dll.mono}">
				<include name="${file.name.dll}" />
			</reference>
		</csc>
	</target>

	<target name="do-compiletestsmono">
		<mkdir dir="${dir.dist.dll.mono}"/>
		<csc srcdir="${src.dir}"
			targettype="exe"
			destfile="${file.exe.tests.mono}"
			debug="true"
			executable="${mono.executable}"
			mainclass="com.db4o.test.AllTests"
			extraoptions="-r:System.Drawing"
			definitions="${mono.definitions}">
			
			<exclude name="compact*/**" />
			<exclude name="**/ListElementByIdentity.cs" />
			<exclude name="**/TestCatSpeed.cs" />
			
			<reference dir="${dir.dist.dll.mono}">
				<include name="${file.name.dll}" />
				<include name="${file.name.dll.tools.mono}" />
			</reference>
		</csc>
	</target>

	<target name="runtestsmono" depends="compiletestsmono">
		<exec executable="mono" dir="${dir.dist.dll.mono}" failifexecutionfails="true" failonerror="true" timeout="300000">
			<arg value="--debug" />
			<arg file="${dir.dist.dll.mono}/${file.name.exe.tests.mono}" />
		</exec>
	</target>
	
	<target name="do-compiledllmono">
		<versioninfo path="${src.dir}/net" net="true" keyfile="${filename.keyfile}" version="${db4o.version.full}" major="${db4o.version.major}"  minor="${db4o.version.minor}"/>
		<csc srcdir="${src.dir}"
			targettype="library"
			destfile="${file.dll.mono}"
			docfile="${file.xml.mono}"
			debug="${compiledll.debug}"
			executable="${mono.executable}"
			warnlevel="0"
			optimize="true"
			definitions="${mono.definitions}">
			<include name="**/*.cs" />
			<exclude name="compact*/**" />
		</csc>
		<versioninfo path="${src.dir}/net" net="true" keyfile="" version="${db4o.version.full}" major="${db4o.version.major}"  minor="${db4o.version.minor}"/>
	</target>

	<target name="compiledllmono" depends="init, sharpen">
		<antcall target="do-compiledllmono">
			<param name="src.dir" location="${dir.n.core.src}" />
		</antcall>
	</target>

	<target name="compiletoolsmono">
		<antcall target="do-compiletoolsmono">
			<param name="src.dir" location="${dir.n.tools.src}" />
		</antcall>
	</target>

	<target name="compiletestsmono">
		<antcall target="do-compiletestsmono">
			<param name="src.dir" location="${dir.n.test.src}" />
		</antcall>
	</target>

	<target name="compiletestsjava" depends="compilecorejava" description="Compile Db4o test sources">
		<mkdir dir="${dir.dist.classes.test}" />
		<mkdir dir="${dir.dist.classes.test.nq}" />
		<delete dir="${dir.dist.classes.test}">
			<include name="**/*" />
		</delete>
		<copy todir="${dir.dist.java.temp.src.test}" overwrite="true">
			<fileset dir="${dir.db4ounit}/src">
				<include name="**/*.java" />
			</fileset>
		</copy>
		<copy todir="${dir.dist.java.temp.src.test}" overwrite="true">
			<fileset dir="${dir.j.test.src}">
				<include name="**/*.java" />
			</fileset>
		</copy>
		<copy todir="${dir.dist.java.temp.src.test}" overwrite="true">
			<fileset dir="${dir.j.jdk1.2.test.src}">
				<include name="**/*.java" />
			</fileset>
		</copy>
		<copy todir="${dir.dist.java.temp.src.test}" overwrite="true">
			<fileset dir="${dir.j.jdk5.test.src}">
				<include name="**/*.java" />
			</fileset>
		</copy>
		<javac destdir="${dir.dist.classes.test}" fork="true" debug="on" target="1.5" source="1.5" encoding="UTF-8">
			<classpath>
				<dirset dir="${dir.dist.classes.java5}" />
			</classpath>
			<src path="${dir.dist.java.temp.src.test}"/>
			<src path="${dir.j.tools.src}" />
		</javac>
		<javac destdir="${dir.dist.classes.test.nq}" fork="true" debug="on" target="1.4" source="1.4" encoding="UTF-8">
			<classpath>
				<dirset dir="${dir.dist.classes.java1.2}" />
				<dirset dir="${dir.dist.classes.nqopt}" />
				<pathelement location="${file.bloat.jar}" />
			</classpath>
			<src path="${dir.j.test.src}"/>
			<src path="${dir.j.tools.src}" />
			<src path="${dir.workspace}/db4ounit/src" />
			<src path="${dir.j.nqopt}/test/src" />
			<src path="${dir.j.nqopt}/core/testsrc" />
		</javac>
	</target>

	<target name="compilejtutorial" depends="compilecorejava" description="Compile Db4o Java tutorial sources">
		<mkdir dir="${dir.dist.classes.tutorial}" />
		<antcall target="copyjava1.2" />
		<javac fork="true" srcdir="${dir.dist.java.temp.src.core}" destdir="${dir.dist.classes.tutorial}" target="1.3" source="1.3" encoding="UTF-8" />
		<javac fork="true" srcdir="${dir.j.tutorial.src}" destdir="${dir.dist.classes.tutorial}" classpath="${dir.dist.classes.tutorial}" target="1.3" source="1.3" debug="on" encoding="UTF-8" />
	</target>
	
	<target name="compilentutorial" depends="compiledllnet">
		<ant dir="${dir.n.tutorial}">
			<property name="csc.executable" value="${csc.executable}" />
		</ant>
	</target>

	<target name="compilejreference" depends="compilecorejava" description="Compile Db4o Java reference sources">
		<mkdir dir="${dir.dist.classes.reference}" />
		<antcall target="copyjava1.2" />
		<javac fork="true" srcdir="${dir.dist.java.temp.src.core}" destdir="${dir.dist.classes.reference}" target="1.3" source="1.3" encoding="UTF-8" />
		<javac fork="true" srcdir="${dir.j.reference.src}" destdir="${dir.dist.classes.reference}" classpath="${dir.dist.classes.reference}" target="1.3" source="1.3" debug="on" encoding="UTF-8" />
	</target>

	<target name="compilenreference" depends="compiledllnet">
		<ant dir="${dir.n.reference}">
			<property name="csc.executable" value="${csc.executable}" />
		</ant>
	</target>
	
	<target name="preparendoc">
		<property name="db4o-namespace-summaries.xml" location="config/db4o-namespace-summaries.xml" />		
		<property name="ndoc.home" location="lib/ndoc" />
				
		<delete dir="${dir.dist.ndoc}" />
		<mkdir dir="${dir.dist.ndoc}" />
	</target>
	
	<target name="ndocmono" depends="preparendoc" description="Builds public .net docs for the mono platform">
		<exec executable="mono" failonerror="true">
			<arg file="${ndoc.home}/bin/${mono.ndoc.executable}" />
			<arg value="${file.dll.mono}" />
			<arg value="-namespacesummaries=${db4o-namespace-summaries.xml}" />
			<arg value="-documenter=MSDN" />
			<arg value="-OutputTarget=Web" />
			<arg value="-OutputDirectory=${dir.dist.ndoc}" />
			<arg value="-Title=db4o" />
			<arg value="-SkipNamespacesWithoutSummaries=True" />
			<arg value="-SdkLinksOnWeb=False" />
            <arg value="-AssemblyVersionInfo=AssemblyVersion" />
			<arg value="-CopyrightText=Copyright (C) 2004 - 2005  db4objects Inc." />
            <arg value="-CopyrightHref=http://www.db4o.com/" />
			<arg value="-CleanIntermediates=True" />
		</exec>
	</target>
	
	<target name="ndoc" depends="preparendoc" description="Build public .net docs">		
		<exec executable="${ndoc.home}/bin/net/${target.framework.version}/NDocConsole.exe">
			<arg value="${file.dll.net}" />
			<arg value="-documenter=MSDN 2003" />
			<arg value="-namespacesummaries=${db4o-namespace-summaries.xml}" />
			<arg value="-OutputDirectory=${dir.dist.ndoc}" />
			<arg value="-HtmlHelpName=db4o" />
			<arg value="-Title=db4o" />
			<arg value="-SkipNamespacesWithoutSummaries=True" />
			<arg value="-SdkLinksOnWeb=False" />
            <arg value="-AssemblyVersionInfo=AssemblyVersion" />
			<arg value="-CopyrightText=Copyright (C) 2004 - 2005  db4objects Inc." />
            <arg value="-CopyrightHref=http://www.db4o.com/" />
			<arg value="-IncludeFavorites=True" />			
		</exec>
	</target>
		
	<target name="vsdoc" depends="ndoc" description="Build VS.NET 2003 integrated docs">
		<exec executable="${ndoc.home}/bin/net/${target.framework.version}/NDocConsole.exe">
			<arg value="${file.dll.net}" />
			<arg value="-namespacesummaries=${db4o-namespace-summaries.xml}" />
			<arg value="-documenter=VS.NET 2003" />
			<arg value="-OutputDirectory=${dir.dist.ndoc}" />
			<arg value="-BuildSeparateIndexFile=false" />
			<arg value="-CollectionNamespace=com.db4o" />
			<arg value="-CreateFullTextIndex=true" />
			<arg value="-GenerateCollectionFiles=true" />
			<arg value="-HtmlHelpName=db4o" />
			<arg value="-IncludeDefaultStopWordList=true" />
			<arg value="-LinkToSdkDocVersion=1.1" />
			<arg value="-PlugInNamespace=ms.vscc" />
			<arg value="-RegisterTitleWithNamespace=true" />
			<arg value="-Title=db4o" />
			<arg value="-SkipNamespacesWithoutSummaries=True" />
			<arg value="-SdkLinksOnWeb=False" />
            <arg value="-AssemblyVersionInfo=AssemblyVersion" />
			<arg value="-CopyrightText=Copyright (C) 2004 - 2005  db4objects Inc." />
            <arg value="-CopyrightHref=http://www.db4o.com/" />
			<arg value="-IncludeFavorites=True" />
			<!--
            <property name="Preliminary" value="True" />
            <property name="CleanIntermediates" value="True" />
            -->
		</exec>
	</target>
	
	<target name="install-vsdoc" depends="vsdoc" description="Register the VS.NET 2003 integrated docs">
		<property name="h2reg.exe" location="lib/h2reg/h2reg.exe" />
		<property name="h2reg.cmdfile" location="${dir.dist.ndoc}/db4oCollection.h2reg.ini" />
		<exec executable="${h2reg.exe}">
			<arg value="-r" />
			<arg value="CmdFile=${h2reg.cmdfile}" />
		</exec>
	</target>
	
	<target name="uninstall-vsdoc" depends="vsdoc" description="Unregister the VS.NET 2003 integrated docs">
		<property name="h2reg.exe" location="lib/h2reg/h2reg.exe" />
		<property name="h2reg.cmdfile" location="${dir.dist.ndoc}/db4oCollection.h2reg.ini" />
		<exec executable="${h2reg.exe}">
			<arg value="-u" />
			<arg value="CmdFile=${h2reg.cmdfile}" />
		</exec>
	</target>

	<target name="javadoc" depends="init" description="Build public javadocs">
		<antcall target="copyjava5" />
		<javadoc classpath="" access="public" windowtitle="db4o - database for objects - documentation" header="db4o ${db4o.version.dotted}" destdir="${dir.dist.doc.api}">
			<fileset dir="${dir.dist.java.temp.src.core}" includes="com/db4o/**/*.java">
				<exclude name="com/db4o/inside/**/*.java" />
				<exclude name="com/db4o/foundation/**/*.java" />
				<not>
					<contains text="* @exclude" />
				</not>
			</fileset>
			<fileset dir="${dir.j.tools.src}" includes="com/db4o/**/*.java">
				<not>
					<contains text="* @exclude" />
				</not>
			</fileset>
			<group title="Core Engine" packages="com.db4o" />
			<group title="Query Functionality" packages="com.db4o.query" />
			<group title="Configuration Features" packages="com.db4o.config" />
			<group title="Extended Functionality" packages="com.db4o.ext" />
			<group title="Messaging" packages="com.db4o.messaging" />
			<group title="Reflection" packages="com.db4o.reflect" />
			<group title="Tools" packages="com.db4o.tools" />
			<group title="Types" packages="com.db4o.types" />
		</javadoc>
		<copy file="${javadoc.stylesheet}" todir="${dir.dist.doc.api}" overwrite="true" />
	</target>

	<target name="runtestsjava" depends="compiletestsjava" description="Run db4o AllTests">
		<copy todir=".">
			<fileset dir="${dir.j}">
				<include name="test/db4oVersions/**/*" />
			</fileset>
		</copy>
		<java fork="true" classname="com.db4o.db4ounit.AllTests" failonerror="true" timeout="180000">
			<classpath>
				<dirset dir="${dir.dist.classes.java5}" />
				<dirset dir="${dir.dist.classes.java1.2}" />
				<dirset dir="${dir.dist.classes.test}" />
				<path path="${path.classpath.full}" />
			</classpath>
			<arg value="-e" />
		</java>
		<java fork="true" classname="com.db4o.nativequery.AllUnitTestsNQ" failonerror="true" timeout="180000">
			<classpath>
				<dirset dir="${dir.dist.classes.java5}" />
				<dirset dir="${dir.dist.classes.java1.2}" />
				<dirset dir="${dir.dist.classes.test}" />
				<dirset dir="${dir.dist.classes.nqopt}" />
				<dirset dir="${dir.dist.classes.test.nq}" />
				<path location="${file.bloat.jar}" />
				<path path="${path.classpath.full}" />
			</classpath>
			<arg value="-e" />
		</java>
		<java fork="true" classname="com.db4o.test.AllTestsJdk5" failonerror="true" timeout="3600000">
			<classpath>
				<dirset dir="${dir.dist.classes.java5}" />
				<dirset dir="${dir.dist.classes.java1.2}" />
				<dirset dir="${dir.dist.classes.test}" />
				<path path="${path.classpath.full}" />
			</classpath>
			<arg value="*" />
		</java>
		<java fork="true" classname="com.db4o.test.nativequery.AllTestsNQ" failonerror="true" timeout="180000">
			<classpath>
				<dirset dir="${dir.dist.classes.nqopt}" />
				<dirset dir="${dir.dist.classes.java1.2}" />
				<dirset dir="${dir.dist.classes.test.nq}" />
				<path location="${file.bloat.jar}" />
				<path path="${path.classpath.full}" />
			</classpath>
		</java>
	</target>

	<target name="zipjavasrc" depends="javadoc,compilecorejava,compiletestsjava">
		<copy todir="${dir.dist.java.src}/${name.project.db4ounit}">
			<fileset dir="${dir.db4ounit}">
				<include name=".project" />
				<include name=".classpath" />
				<include name="src/**" />
			</fileset>
		</copy>
		<copy todir="${dir.dist.java.src}/${name.project.j}">
			<fileset dir="${dir.j}">
				<include name=".project" />
				<include name=".classpath" />
				<include name="build.xml" />
				<include name="**/src/**" />
				<!-- exclude name="tools/**" / -->
			</fileset>
		</copy>
		<copy todir="${dir.dist.java.src}/${name.project.jdk1.2}">
			<fileset dir="${dir.j.jdk1.2}">
				<include name=".project" />
				<include name=".classpath" />
				<include name="build.xml" />
				<include name="**/src/**" />
			</fileset>
		</copy>
		<copy todir="${dir.dist.java.src}/${name.project.jdk5}">
			<fileset dir="${dir.j.jdk5}">
				<include name=".project" />
				<include name=".classpath" />
				<include name="build.xml" />
				<include name="**/src/**" />
			</fileset>
		</copy>
		<copy todir="${dir.dist.java.src}/${name.project.nqopt}">
			<fileset dir="${dir.j.nqopt}">
				<include name=".project" />
				<include name=".classpath" />
				<include name="build.xml" />
				<include name="**/src/**" />
			</fileset>
		</copy>
		<filehead beforePattern="package" header="${content.gplheader}" >
			<sources dir="${dir.dist.java.src}">
				<include name="**/*.java" />
			</sources>
		</filehead>

		<zip destfile="${file.java.core.src.zip}">
			<fileset dir="${dir.dist.java.src}" includes="*/**" excludes="*.zip">
				<include name="*/**" />
				<exclude name="*.zip" />
				<exclude name="tools/**" />
			</fileset>
		</zip>
		<delete includeemptydirs="true">
			<fileset dir="${dir.dist.java.src}">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

	<target name="zipjavatest" depends="javadoc,compilecorejava,compiletestsjava">
		<copy todir="${dir.dist.java.src}">
			<fileset dir="${dir.j.test.src}" />
		</copy>
		<filehead beforePattern="package" header="${content.gplheader}" >
			<sources dir="${dir.dist.java.src}">
				<include name="**/*.java" />
			</sources>
		</filehead>
		<zip destfile="${file.java.test.src.zip}">
			<fileset dir="${dir.dist.java.src}" includes="*/**" excludes="*.zip" />
		</zip>
		<delete includeemptydirs="true">
			<fileset dir="${dir.dist.java.src}">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

	<target name="zipjava" depends="zipjavasrc, init" description="Zip Java distribution">
		<copy todir="${dir.dist.java.src}">
			<fileset file="${file.java.core.src.zip}" />
			<fileset dir="${dir.j}">
				<include name="tools/**/*.java" />
			</fileset>
		</copy>
		<filehead beforePattern="package" header="${content.gplheader}" >
			<sources dir="${dir.dist.java.src}">
				<include name="**/*.java" />
			</sources>
		</filehead>
		<copy todir="${dir.dist.java.build.tutorial}">
			<fileset dir="${dir.j.tutorial.out.java}">
				<include name="**/**" />
			</fileset>
			<fileset dir="${dir.j.tutorial}">
				<include name="src/**/*.java" />
			</fileset>
		</copy>

		<copy todir="${dir.dist.java.build}">
			<fileset dir="${dir.dist}" includes="doc/**" />
			<fileset dir="${dir.dist.java}" includes="lib/**" />
			<fileset dir="${dir.dist.java}" includes="src/**" />
			<fileset dir="${dir.j}" includes="${filename.db4o.license}" />
			<fileset dir="${dir.config}" includes="README.txt" />
		</copy>
		<zip destfile="${file.dist.java}">
			<fileset dir="${dir.dist.java}" includes="${folder.build}/**" />
		</zip>
	</target>

	<target name="zipnet" depends="init, configure-net1.1, compilenet-all, vsdoc, do-zipnet-pascalcase">
	</target>
	
	<target name="zipnet2" depends="init, configure-net2, compilenet-all, ndoc, net2-instrumentation, do-zipnet-pascalcase">
	</target>
	
	<target name="configure-net1.1">

		<property name="target.framework.version" value="1.1" />
			
		<property name="csc.executable.path.net1" location="${env.SystemRoot}/Microsoft.NET/Framework/v1.1.4322" />
		<property name="csc.executable" location="${csc.executable.path.net1}/csc.exe" />
		
		<available property="csc.executable.available" file="${csc.executable}"></available>
		<fail unless="csc.executable.available">
		.net 1.1 c# compiler not found at '${csc.executable.path.net1}', please configure your machine.properties by setting the property 'csc.executable.path.net1' accordingly.
		</fail>
		
		<property name="csharp.defines" value="NET" />
		
		<property name="csharp.defines.cf" value="CF_1_0" />		
		<property name="dir.dll.wince" value="${dir.compactframework}v1.0/WindowsCE/" />
			
		<property name="installer.package.guid" value="${installer.package.guid.net1}" />
		<property name="installer.upgrade.guid" value="${installer.upgrade.guid.net1}" />
		<property name="installer.package.suffix" value="net" />
	</target>	
	
	<target name="configure-net2">
		
		<property name="target.framework.version" value="2.0" />
		
		<property name="csc.executable.path.net2" location="${env.SystemRoot}/Microsoft.NET/Framework/v2.0.50727" />
		<property name="csc.executable" location="${csc.executable.path.net2}/csc.exe" />
		
		<property name="csharp.defines" value="NET_2_0" />
		<property name="csharp.defines.cf" value="CF_2_0" />		
		<property name="dir.dll.wince" value="${dir.compactframework}v2.0/WindowsCE/" />
		
		<property name="installer.package.suffix" value="net2" />
		<property name="installer.package.guid" value="${installer.package.guid.net2}" />
		<property name="installer.upgrade.guid" value="${installer.upgrade.guid.net2}" />
	</target>
	
	<target name="do-zipnet-pascalcase">
		<antcall target="doctor">
		</antcall>
		
		<antcall target="create-zipnet">
			<param name="dir.core" value="${dir.n.core}" />
			<param name="dir.tools" value="${dir.n.tools}" />
			<param name="dir.test" value="${dir.n.test}" />
			<param name="dir.tutorial" value="${dir.n.tutorial}" />
		</antcall>
	</target>
		
	<target name="create-zipnet">
		<mkdir dir="${dir.dist.net.src.core}" />
		<copy todir="${dir.dist.net.src.core}">
			<fileset dir="${dir.core}">
				<include name="**/*.cs" />
				<include name="*.*" />
				<exclude name=".*" />
			</fileset>
		</copy>
		<versioninfo path="${dir.dist.net.src.core}/src/net" net="true" keyfile="" version="${db4o.version.full}" major="${db4o.version.major}"  minor="${db4o.version.minor}"/>
		<versioninfo path="${dir.dist.net.src.core}/src/compact" compact="true" keyfile="" version="${db4o.version.full}" major="${db4o.version.major}"  minor="${db4o.version.minor}"/>
		<mkdir dir="${dir.dist.net.src.tools}" />
		<copy todir="${dir.dist.net.src.tools}">
			<fileset dir="${dir.tools}">
				<include name="**/*.cs" />
				<include name="*.*" />
				<exclude name=".*" />
			</fileset>
		</copy>
		<mkdir dir="${dir.dist.net.src.test}" />
		<copy todir="${dir.dist.net.src.test}">
			<fileset dir="${dir.test}">
				<include name="**/*.cs" />
				<include name="**/*.resx" />
				<include name="lib/Db4oUnit.dll" />
				<include name="*.*" />
				<exclude name=".*" />
			</fileset>
		</copy>
		<copy todir="${dir.dist.net.build.tutorial}">
			<fileset dir="${dir.j.tutorial.out.net}">
				<include name="**/**" />
			</fileset>
			<fileset dir="${dir.tutorial}">
				<include name="**/*.cs" />
				<include name="vb/**/*.vb" />
				<include name="vb/**/*.vbproj" />
				<include name="vb/**/*.sln" />
				<exclude name="db4o-tutorial/**/*.*" />
			</fileset>
			<fileset dir="${dir.n.tutorial.bin}">
				<include name="**/*.dll" />
				<include name="**/*.exe" />
				<include name="**/*.config" />
			</fileset>
		</copy>
		
		<copy todir="${dir.dist.net.build.tutorial}/vb">
			<fileset dir="${dir.j.tutorial.out.vb}">
				<include name="**/**" />
			</fileset>
		</copy>	

		<copy todir="${dir.dist.net.build}">
			<fileset dir="${dir.dist}" includes="dll/**/**" />
			<fileset dir="${dir.j}" includes="${filename.db4o.license}" />
			<fileset dir="${dir.config}" includes="README.txt" />
			<fileset dir="${dir.dist.net.instrumentation}" includes="**/**" />
		</copy>
		
		<filehead beforePattern="using|namespace" header="${content.gplheader}" >
			<sources dir="${dir.dist.net.build.src}">
				<include name="**/*.cs" />
				<exclude name="**/tools/Libs/**" />
			</sources>
		</filehead>
		
		<mkdir dir="${dir.dist.net.build}/doc/api" />
		
		<copy todir="${dir.dist.net.build}/doc/api">
			<fileset dir="${dir.dist}/ndoc">
				<include name="db4o.chm" />
				<include name="db4o.HxS" />
				<include name="db4oCollection.*" />
				<include name="db4oCollection.h2reg.ini" />
			</fileset>
			<fileset dir="lib/h2reg">
				<include name="*.exe" />
				<include name="*.ini" />
			</fileset>
		</copy>
		
		<zip destfile="${dir.dist}/${db4o.file}${installer.package.suffix}.zip">
			<fileset dir="${dir.dist.net}" includes="${folder.build}/**" />
		</zip>
		
		<ant antfile="build-net-installer.xml">
			<property name="installer.package.guid" value="${installer.package.guid}" />
			<property name="installer.upgrade.guid" value="${installer.upgrade.guid}" />
			<property name="target.framework.version" value="${target.framework.version}" />
		</ant>
	</target>
	
	<target name="do-zipmono-pascalcase">
		<mkdir dir="${dir.dist.mono.src.core}" />
		
		<antcall target="sharpen">
		</antcall>
			
		<antcall target="do-compiledllmono">
			<param name="src.dir" location="${dir.n.core.src}" />
		</antcall>
		<antcall target="do-compiletoolsmono">
			<param name="src.dir" location="${dir.n.tools.src}" />
		</antcall>
		<antcall target="do-compiletestsmono">
			<param name="src.dir" location="${dir.n.test.src}" />
		</antcall>
		
		<antcall target="ndocmono">
		</antcall>
		
		<antcall target="doctor">
		</antcall>
		
		<antcall target="prepare-mono-distro">
		</antcall>
	</target>
	
	<target name="zipmono-pascalcase" depends="init"  description="Zip Mono PascalCase distribution">
		<antcall target="do-zipmono-pascalcase">
			<param name="mono.definitions" value="MONO" />
			<param name="mono.executable" value="${mono.mcs.executable}" />
			<param name="mono.ndoc.executable" value="mono/1.0/NDocConsole.exe" />
		</antcall>
	</target>

	<target name="zipmono2-pascalcase" depends="init"  description="Zip Mono with generics PascalCase distribution">
		<antcall target="do-zipmono-pascalcase">
			<param name="mono.definitions" value="MONO;NET_2_0" />
			<param name="mono.executable" value="${mono.gmcs.executable}" />
			<param name="mono.ndoc.executable" value="net/2.0/NDocConsole.exe" />
		</antcall>
	</target>
	
	<target name="zipmono" depends="init, compiledllmono, ndocmono" description="Zip Mono distribution">
		<antcall target="prepare-mono-distro" />
	</target>
		
	<target name="prepare-mono-distro">
		<mkdir dir="${dir.dist.mono.src.core}" />
		<copy todir="${dir.dist.mono.src.core}">
			<fileset dir="${dir.n.core}">
				<include name="**/*.cs" />
				<include name="**/*.csproj" />
				<include name="**/*.sln" />				
				<include name="**/*.mdp" />
				<include name="**/*.mds" />
				<exclude name="**/compact*/**"/>
			</fileset>
		</copy>
		<versioninfo path="${dir.dist.mono.src.core}/src/net" net="true" keyfile="" version="${db4o.version.full}" major="${db4o.version.major}"  minor="${db4o.version.minor}"/>
		<mkdir dir="${dir.dist.mono.src.tools}" />
		<copy todir="${dir.dist.mono.src.tools}">
			<fileset dir="${dir.n.tools}">
				<include name="**/*.cs" />
				<include name="**/*.csproj" />
				<include name="**/*.sln" />				
				<include name="**/*.mdp" />
				<include name="**/*.mds" />
			</fileset>
		</copy>
		<mkdir dir="${dir.dist.mono.src.test}" />
		<copy todir="${dir.dist.mono.src.test}">
			<fileset dir="${dir.n.test}">
				<include name="**/*.cs" />
				<exclude name="**/compact/**"/>
				<exclude name="**/CsImage.cs" />
				<include name="**/*.csproj" />
				<include name="**/*.sln" />				
				<include name="**/*.mdp" />
				<include name="**/*.mds" />
			</fileset>
		</copy>
		<mkdir dir="${dir.dist.mono.build.tutorial}" />
		<copy todir="${dir.dist.mono.build.tutorial}">
			<fileset dir="${dir.n.tutorial}">
				<include name="**/*.cs" />
				<exclude name="db4o-tutorial/**/*.*" />
			</fileset>
		</copy>
		<copy todir="${dir.dist.mono.build.tutorial}">
			<fileset dir="${dir.j.tutorial.out.mono}">
				<include name="**/**" />
			</fileset>
		</copy>
		<mkdir dir="${dir.dist.mono.build.tutorial}/vb" />
		<copy todir="${dir.dist.mono.build.tutorial}/vb">
			<fileset dir="${dir.j.tutorial.out.vb}">
				<include name="**/**" />
			</fileset>
		</copy>

		<filehead beforePattern="using|namespace|#if" header="${content.gplheader}" >
			<sources dir="${dir.dist.mono.build.src}">
				<include name="**/*.cs" />
			</sources>
		</filehead>
		<copy todir="${dir.dist.mono.build}">
			<fileset dir="${dir.dist.mono}" includes="dll/**/**" />
			<fileset dir="${dir.j}" includes="GPL.txt" />
			<fileset dir="${dir.config}" includes="README.txt" />
		</copy>
		<mkdir dir="${dir.dist.mono}/doc/api" />
		<copy todir="${dir.dist.mono}/doc/api">
			<fileset dir="${dir.dist.ndoc}" includes="**/**" />
		</copy>
	</target>	
		
	<target name="prepare-conversion-workspace" depends="init">
		<delete dir="${target.dir}" />
		<mkdir dir="${target.dir}" />
		
		<copy todir="${target.dir}">
			<fileset dir="..">
				<include name="db4oj/core/src/**/*.java" />
			</fileset>
		</copy>
		
		<!-- shared native query support -->
		<copy todir="${target.dir}/db4oj">
			<fileset dir="../db4onqopt">
				<include name="core/src/com/db4o/nativequery/expr/**/*.java" />
				<include name="core/src/com/db4o/nativequery/optimization/SODAQueryBuilder.java" />
				<include name="core/src/com/db4o/nativequery/optimization/ComparisonQueryGeneratingVisitor.java" />
				<include name="core/src/com/db4o/nativequery/optimization/ReflectUtil.java" />
			</fileset>
		</copy>
		
		<copy todir="${target.dir}/db4oj/core/src" overwrite="true">
			<fileset dir="../db4on/in/java">
				<include name="**/*.java" />
			</fileset>
		</copy>
	</target>
	
	<target name="net2-instrumentation" depends="compilenet-all">
		
		<property name="dir.n.instrumentation" location="../db4on/instrumentation" />
		
		<ant antfile="build-net-instrumentation.xml"
			target="rebuild"
			inheritall="false">
			<property name="csc.executable" value="${csc.executable}"></property>
		</ant>
		
		<copy todir="${dir.dist.net.instrumentation}">
			<fileset dir="${dir.n.instrumentation}">
				<include name="bin/*.dll" />
				<include name="bin/*.exe" />
				<exclude name="bin/Db4oUnit.dll" />
			</fileset>
		</copy>
		
		<copy todir="${dir.dist.net.instrumentation}/src/instrumentation">				
			<fileset dir="${dir.n.instrumentation}">
				<include name="Db4oAdmin/**/*.cs" />
				<include name="Db4oAdmin/**/*.csproj" />
				<include name="Db4oAdmin/**/*.sln" />
				
				<include name="Db4oAdmin.Tests/**/*.cs" />
				<include name="Db4oAdmin.Tests/**/*.csproj" />
				<include name="Db4oAdmin.Tests/**/*.sln" />
				
				<include name="Db4oAdmin.Example/**/*.cs" />
				<include name="Db4oAdmin.Example/**/*.csproj" />
				<include name="Db4oAdmin.Example/**/*.sln" />
			</fileset>
		</copy>
		
		<updateAssemblyHintPath to="../../../dll/net/${file.name.dll}">
			<projectFiles dir="${dir.dist.net.instrumentation}">
				<include name="**/*.csproj" />
				<exclude name="**/*.Example.csproj" />
			</projectFiles>
		</updateAssemblyHintPath>
		
		<updateAssemblyHintPath to="../../../dll/compact/${file.name.dll}">
			<projectFiles dir="${dir.dist.net.instrumentation}">
				<include name="**/*.Example.csproj" />
			</projectFiles>
		</updateAssemblyHintPath>
	</target>
	
	<target name="compilenet-all" depends="sharpen">
		
		<antcall target="compilecoredll-compact">
		</antcall>
		
		<antcall target="compiletools-compact">
		</antcall>

		<antcall target="compilecoredll-net">
		</antcall>
		
		<antcall target="compiletools-net">
		</antcall>
		
		<ant dir="${dir.n.tutorial}">
			<property name="dir.db4obuild" location="." />
		</ant>
		
	</target>
	
	<target name="copy-sharpened-files">
		<copy todir="${target.dir}">
			<fileset dir="${src.dir}">
				<include name="**/*.cs" />
				<exclude name="com/db4o/handlers/*.*" />
				<exclude name="com/db4o/eclipse/**/*.*" />
				<exclude name="com/db4o/reflect/jdk/**/*.*" />
				<exclude name="com/db4o/foundation/Lock4.cs" />
				<exclude name="com/db4o/foundation/ArgumentNullException.cs" />
				<exclude name="com/db4o/JDK_*.cs" />
				<exclude name="com/db4o/JDKReflect*.cs" />
				<exclude name="com/db4o/CoercionReflect.cs" />
				<exclude name="com/db4o/JavaOnly.cs" />
				<exclude name="com/db4o/config/TSerializable.cs" />
				<exclude name="com/db4o/config/TCollection.cs" />
				<exclude name="com/db4o/config/THashtable.cs" />
				<exclude name="com/db4o/config/TMap.cs" />
				<exclude name="com/db4o/config/TTreeMap.cs" />
				<exclude name="com/db4o/config/TTreeSet.cs" />
				<exclude name="com/db4o/config/TVector.cs" />
				<exclude name="com/db4o/events/EventArgs.cs" />
				<exclude name="com/db4o/events/Event4.cs" />
				<exclude name="com/db4o/events/EventListener4.cs" />
				<exclude name="com/db4o/events/impl/Event4Impl.cs" />
				<exclude name="com/db4o/reflect/self/*.*" />
				
			</fileset>
		</copy>
	</target>	
	
	<target name="sharpen-db4ounit-extensions" depends="install-javatocsharp-plugin">		
		
		<property name="target.dir" value="${dir.sharpen}" />
		
		<delete dir="${target.dir}" />
		<mkdir dir="${target.dir}" />
		
		<mkdir dir="${target.dir}/lib" />
		<property name="dependencies.jar" location="${target.dir}/lib/dependencies.jar" />
		<jar destfile="${dependencies.jar}">			
			<fileset dir="${dir.workspace}/db4oj/bin/">								
				<exclude name="db4ounit/**" />
			</fileset>
			<fileset dir="${dir.workspace}/db4ounit/bin/">
			</fileset>
		</jar>
				
		<copy todir="${target.dir}">
			<fileset dir="..">
				<include name="db4oj/test/src/db4ounit/**/*.java" />
			</fileset>
		</copy>
		
		<sharpen workspace="${target.dir}" resource="db4oj/test/src">
			<args>
				<arg value="-pascalcase" />
				
				<arg value="-nativeTypeSystem" />
				
				<arg value="-cp" />
				<arg path="${dependencies.jar}" />
				
				<arg value="-typeMapping" />
				<arg value="com.db4o.foundation.ArgumentNullException" />
				<arg value="System.ArgumentNullException" />
				
				<arg value="-namespaceMapping" />
				<arg value="^db4ounit.extensions.fixtures" />
				<arg value="Db4oUnit.Extensions.Fixtures" />
				
				<arg value="-namespaceMapping" />
				<arg value="^db4ounit.extensions" />
				<arg value="Db4oUnit.Extensions" />
				
				<arg value="-namespaceMapping" />
				<arg value="^db4ounit" />
				<arg value="Db4oUnit" />
			</args>
		</sharpen>
		
		<copy todir="${dir.n}/Db4oUnit.Extensions/src">
			<fileset dir="${target.dir}/db4ojcsharp/src">
				<include name="Db4oUnit/**/*.cs" />
			</fileset>
		</copy>
	</target>
	
	<target name="sharpen" description="create .NET sources" depends="install-javatocsharp-plugin" unless="skip.conversion">

		<property name="sharpen.src.dir" location="${dir.sharpen}" />
		
		<antcall target="prepare-conversion-workspace">
			<param name="target.dir" value="${sharpen.src.dir}" />
		</antcall>
		
		<sharpen workspace="${sharpen.src.dir}" resource="db4oj/core/src">
			<args>
				<arg value="-pascalcase" />
				
				<arg value="-typeMapping" />
				<arg value="com.db4o.foundation.ArgumentNullException" />
				<arg value="System.ArgumentNullException" />
				
				<arg value="-typeMapping" />
				<arg value="com.db4o.events.EventArgs" />
				<arg value="System.EventArgs" />
			</args>
		</sharpen>
		
		<antcall target="copy-sharpened-files">
			<param name="src.dir" value="${sharpen.src.dir}/db4ojcsharp/src" />
			<param name="target.dir" value="${dir.n.core.src}/core" />
		</antcall>
		
		<copy todir="${dir.n.core.src}" overwrite="true">
			<fileset dir="${dir.n.in.sharp}">
				<include name="**/*.cs" />
			</fileset>
		</copy>
			
		<updatecsharpproject projectFile="${dir.n.core}/db4o-net.csproj">
			<sources dir="${dir.n.core}">
				<include name="**/*.cs" />
				<exclude name="src/compact*/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectFile="${dir.n.core}/db4o-net2.csproj">
			<sources dir="${dir.n.core}">
				<include name="**/*.cs" />
				<exclude name="src/compact*/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectFile="${dir.n.core}/db4o-compact.csdproj">
			<sources dir="${dir.n.core}">
				<include name="**/*.cs" />
				<exclude name="src/net/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectFile="${dir.n.core}/db4o-compact-2005.csproj">
			<sources dir="${dir.n.core}">
				<include name="**/*.cs" />
				<exclude name="src/net/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectFile="${dir.n.core}/db4o-mono.mdp">
			<sources dir="${dir.n.core}">
				<include name="**/*.cs" />
				<exclude name="src/compact*/**" />
			</sources>
		</updatecsharpproject>
		
		<fileset id="tools.sources" dir="${dir.n.tools}">
			<include name="**/*.cs" />
			<exclude name="Libs/**/AssemblyInfo.cs" />
			<exclude name="Libs/Mono.Cecil/CodeGen/**/*.*" />
			<exclude name="Libs/Cecil.FlowAnalysis/codegen/**/*.*" />
			<exclude name="Libs/Cecil.FlowAnalysis/Cecil.FlowAnalysis.Tests/**/*.*" />
		</fileset>
		
		<updatecsharpproject projectfile="${dir.n.tools}/db4o-compact-tools.csdproj">
			<sources refid="tools.sources"/>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.tools}/db4o-compact-tools-2005.csproj">
			<sources refid="tools.sources"/>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.tools}/db4o-net2-tools.csproj">
			<sources refid="tools.sources"/>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.tools}/db4o-net-tools.csproj">
			<sources refid="tools.sources"/>
		</updatecsharpproject>
		
		<antcall target="sharpen-db4ounit-db4o" />
		
		<updatecsharpproject projectfile="${dir.n.test}/db4o-compact-test.csdproj">
			<sources dir="${dir.n.test}">
				<include name="**/*.cs" />
				<exclude name="**/compact-2005/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.test}/db4o-compact-test-2005.csproj">
			<sources dir="${dir.n.test}">
				<include name="**/*.cs" />
				<exclude name="**/compact/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.test}/db4o-net2-test.csproj">
			<sources dir="${dir.n.test}">
				<include name="**/*.cs" />
				<exclude name="**/compact*/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.test}/db4o-net-test.csproj">
			<sources dir="${dir.n.test}">
				<include name="**/*.cs" />
				<exclude name="**/compact*/**" />
			</sources>
		</updatecsharpproject>
		
	</target>
	
	<target name="doctor" depends="init, compilecorejava, compilejtutorial, compilejreference" description="Run all doctor tasks">
		<ant antfile="run-doctor.xml" />
	</target>

	<target name="buildjava" depends="doctor, zipjava" description="Full java build" />

	<target name="buildnet" depends="zipnet" description="Full PascalCase NET build" />
	
	<target name="buildnet2" depends="zipnet2" description="Full PascalCase NET 2.0 build" />
	
	<target name="buildmono" depends="zipmono-pascalcase" description="Full Mono build (now PascalCase)" />
	
	<target name="buildmono2" depends="zipmono2-pascalcase" description="Full Mono build with generics (now PascalCase)" />

	<target name="buildall" depends="clean, buildjava, buildnet" description="Full clean build" />
	
	<target name="buildall2" depends="clean, buildjava, buildnet2" description="Full clean build (.net 2 runtime)" />
	
	<target name="serversidecopy">
		<copy todir="${dir.server.downloads}" overwrite="true">
			<fileset dir="${dir.dist}">
				<include name="*.zip" />
				<include name="*.msi" />
			</fileset>
			<fileset dir="${dir.dist.java.build.tutorial}">
				<include name="*.pdf" />
			</fileset>

		</copy>
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.5.B.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.5.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.6.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.7.J.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.7.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.8.J.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.8.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.9.J.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.9.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o2U.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o30.J.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4o30.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4oD.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4oE.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4oEU.zip" />
		<copy overwrite="true" file="${file.server.java}" tofile="${dir.server.downloads}/db4oU.zip" />
		<copy overwrite="true" file="${file.server.net}" tofile="${dir.server.downloads}/db4o2.7.N.zip" />
		<copy overwrite="true" file="${file.server.net}" tofile="${dir.server.downloads}/db4o2.8.N.zip" />
		<copy overwrite="true" file="${file.server.net}" tofile="${dir.server.downloads}/db4o2.9.N.zip" />
		<copy overwrite="true" file="${file.server.net}" tofile="${dir.server.downloads}/db4o30.N.zip" />
	</target>

	<target name="serverside" depends="buildall, serversidecopy" />
	
</project>
