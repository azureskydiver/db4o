<?xml version="1.0"?>
<project name="Db4objects.Db4o" default="build">
	<import file="common.xml" />
	
	<property name="dir.n.v6" location="../db4o.net" />	
	<property name="dir.n.v6.core" location="../db4o.net/Db4objects.Db4o" />	
	<property name="dir.n.v6.core.src" location="${dir.n.v6.core}/Db4objects.Db4o/" />	
	<property name="dir.n.v6.tools" location="${dir.n.v6}/Db4objects.Db4o.Tools/" />
	
	<condition property="mono" value="1">
		<os family="unix" />
	</condition>
	
	<fileset id="db4oj.srcfiles" dir="..">
		<include name="db4oj/core/src/**/*.java" />
	</fileset>
	
	<target name="check-dependencies">
		<uptodate
			property="csharp.uptodate"
			targetfile="${dir.n.v6.core.src}/Transaction.cs">
			<srcfiles refid="db4oj.srcfiles">
			</srcfiles>
		</uptodate>
	</target>
	
	<target name="configure-net2">
		<property name="csharp.definitions" value="NET_2_0" />
	</target>
	
	<target name="run-tests" depends="configure-net2, run-tests-mono, run-tests-net" description="builds and runs all tests">
	</target>
	
	<target name="run-tests-net" depends="build-tests" unless="mono">
		<exec executable="${dir.dist.dll}/Db4objects.Db4o.Tests.exe">
		</exec>
	</target>
	
	<target name="run-tests-mono" depends="build-tests" if="mono">
		<exec executable="mono">
			<arg value="--debug" />
			<arg file="${dir.dist.dll}/Db4objects.Db4o.Tests.exe" />
		</exec>
	</target>
	
	<target name="build" depends="configure-net2, build-core, build-tools, build-tests">
	</target>
	
	<target name="rebuild" depends="clean, build">
	</target>
		
	<target name="build-tests" depends="build-tools, build-db4ounit-extensions">
		<csc
			destfile="${dir.dist.dll}/Db4objects.Db4o.Tests.exe"
			targettype="exe"
			srcdir="${dir.n.v6}/Db4objects.Db4o.Tests"
			mainclass="Db4objects.Db4o.Tests.AllTests"
			definitions="${csharp.definitions}">
			<reference dir="${dir.dist.dll}">
				<include name="Db4objects.Db4o.dll" />
				<include name="Db4oUnit.dll" />
				<include name="Db4oUnit.Extensions.dll" />
			</reference>
		</csc>
	</target>
		
	<target name="build-db4ounit-extensions" depends="build-core, build-db4ounit"> 
		<csc
			destfile="${dir.dist.dll}/Db4oUnit.Extensions.dll"
			targettype="library"
			srcdir="${dir.n.v6}/Db4oUnit.Extensions">
			<reference dir="${dir.dist.dll}">
				<include name="Db4oUnit.dll" />
				<include name="Db4objects.Db4o.dll" />
			</reference>
		</csc>
	</target>
	
	<target name="build-db4ounit" depends="sharpen-db4ounit">
	</target>
	
	<target name="build-tools" depends="build-core">
		<csc
			destfile="${dir.dist.dll}/Db4objects.Db4o.Tools.dll"
			targettype="library"
			definitions="${csharp.definitions}">
			
			<src refid="tools.sources" />
			
			<reference dir="${dir.dist.dll}">
				<include name="Db4objects.Db4o.dll" />
			</reference>
		</csc>
	</target>
	
	<target name="build-core" depends="check-dependencies, sharpen">
		<csc
			destfile="${dir.dist.dll}/Db4objects.Db4o.dll"
			srcdir="${dir.n.v6.core}"
			targettype="library"
			definitions="${csharp.definitions}">
			<include name="**/*.cs" />
			<exclude name="native/compact/*.cs" />
		</csc>
	</target>
	
	<target name="sharpen-tools">
		<fileset id="tools.sources" dir="${dir.n.v6.tools}">
			<include name="**/*.cs" />
			<exclude name="Libs/**/AssemblyInfo.cs" />
			<exclude name="Libs/Mono.Cecil/CodeGen/**/*.*" />
			<exclude name="Libs/Cecil.FlowAnalysis/codegen/**/*.*" />
			<exclude name="Libs/Cecil.FlowAnalysis/Cecil.FlowAnalysis.Tests/**/*.*" />
		</fileset>
		
		<updatecsharpproject projectfile="${dir.n.v6.tools}/Db4objects.Db4o.Tools-compact.csdproj">
			<sources refid="tools.sources"/>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.v6.tools}/Db4objects.Db4o.Tools-compact-2005.csproj">
			<sources refid="tools.sources"/>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.v6.tools}/Db4objects.Db4o.Tools-2005.csproj">
			<sources refid="tools.sources"/>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.v6.tools}/Db4objects.Db4o.Tools.csproj">
			<sources refid="tools.sources"/>
		</updatecsharpproject>
	</target>
	
	<target name="sharpen" depends="sharpen-core, sharpen-tools, sharpen-db4ounit, sharpen-db4ounit-extensions, sharpen-tests">
	</target>
	
	<target name="prepare-conversion-workspace" depends="init">
		<delete dir="${dir.sharpen}" />
		<mkdir dir="${dir.sharpen}" />
		
		<copy todir="${dir.sharpen}">
			<fileset refid="db4oj.srcfiles" />
		</copy>
		
		<!-- shared native query support -->
		<copy todir="${dir.sharpen}/db4oj">
			<fileset dir="../db4onqopt">
				<include name="core/src/com/db4o/nativequery/expr/**/*.java" />
				<include name="core/src/com/db4o/nativequery/optimization/SODAQueryBuilder.java" />
				<include name="core/src/com/db4o/nativequery/optimization/ComparisonQueryGeneratingVisitor.java" />
				<include name="core/src/com/db4o/nativequery/optimization/ReflectUtil.java" />
			</fileset>
		</copy>
		
		<copy todir="${dir.sharpen}/db4oj/core/src" overwrite="true">
			<fileset dir="${dir.n.in.java}">
				<include name="**/*.java" />
			</fileset>
		</copy>
	</target>
	
	<target name="copy-sharpened-files">
		
		<copy todir="${target.dir}">
			<fileset dir="${src.dir}/Db4objects/Db4o">
				<include name="**/*.cs" />
				<exclude name="JDK_*.cs" />
				<exclude name="JDKReflect*.cs" />
				<exclude name="Handlers/*.*" />
				<exclude name="Reflect/Jdk/**/*.*" />
				<exclude name="Reflect/Self/*.*" />
			</fileset>
		</copy>
	</target>	

	<target name="sharpen-core" depends="install-javatocsharp-plugin, prepare-conversion-workspace" unless="csharp.uptodate">

		<sharpen workspace="${dir.sharpen}" resource="db4oj/core/src">
			<args>
				<arg value="@sharpen-new-core-mapping" />
			</args>
		</sharpen>
		
		<delete failonerror="false">
			<fileset dir="${dir.n.v6.core.src}">
				<include name="**/*.cs" />
				<exclude name="**/.svn/**" />
			</fileset>
		</delete>
		<antcall target="copy-sharpened-files">
			<param name="src.dir" value="${dir.sharpen}/db4ojcsharp/src" />
			<param name="target.dir" value="${dir.n.v6.core.src}" />
		</antcall>
			
		<updatecsharpproject projectFile="${dir.n.v6.core}/Db4objects.Db4o-2005.csproj">
			<sources dir="${dir.n.v6.core}">
				<include name="**/*.cs" />
				<exclude name="native/compact*/**" />
			</sources>
		</updatecsharpproject>		
	</target>
	
	<target name="sharpen-db4ounit">
		<ant antfile="build-new-db4ounit.xml" target="buildnet" inheritall="false">
		</ant>
	</target>
	
	<target name="compiletestsjava">
		<ant antfile="build.xml" target="compiletestsjava" />
	</target>
		
	<target name="sharpen-db4ounit-extensions" depends="compiletestsjava, install-javatocsharp-plugin">		
		
		<property name="target.dir" value="${dir.sharpen}" />
		
		<delete dir="${target.dir}" />
		<mkdir dir="${target.dir}" />
		
		<mkdir dir="${target.dir}/lib" />
		<property name="dependencies.jar" location="${target.dir}/lib/dependencies.jar" />
		<jar destfile="${dependencies.jar}">			
			<fileset dir="${dir.dist.classes.java1.1}" />
			<fileset dir="${dir.dist.classes.db4ounit}" />
			<fileset dir="${dir.dist.classes.test.jdk1.1}" />
		</jar>

		<copy todir="${target.dir}/db4ounit.extensions/src">
			<fileset dir="${dir.db4ounit.extensions.src}">
				<include name="**/*.java" />
			</fileset>
		</copy>
		
		<sharpen workspace="${target.dir}" resource="db4ounit.extensions/src">
			<args>
				<arg value="-cp" />
				<arg path="${dependencies.jar}" />
				<arg value="@sharpen-db4ounit-options" />
				<arg value="@sharpen-new-core-mapping" />
			</args>
		</sharpen>
		
		<property name="dir.n.v6.extensions" location="${dir.n.v6}/Db4oUnit.Extensions" />
		
		<delete failonerror="false">
			<fileset dir="${dir.n.v6.extensions}">
				<include name="**/*.cs" />
				<exclude name="**/.svn/**" />
			</fileset>
		</delete>
		
		<copy todir="${dir.n.v6.extensions}/Db4oUnit.Extensions">
			<fileset dir="${target.dir}/db4ounit.extensionscsharp/src">
				<include name="Db4oUnit/**/*.cs" />
			</fileset>
		</copy>
		
		<updatecsharpproject projectFile="${dir.n.v6.extensions}/Db4oUnit.Extensions.csproj">
			<sources dir="${dir.n.v6.extensions}">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectFile="${dir.n.v6.extensions}/Db4oUnit.Extensions-2005.csproj">
			<sources dir="${dir.n.v6.extensions}">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject>
	</target>		
	
	<target name="sharpen-tests" depends="sharpen-db4ounit-extensions">
		
		<property name="target.dir" location="${dir.sharpen}" />
		
		<copy todir="${target.dir}/db4oj.tests/src">
			<fileset dir="${dir.j.tests.src}">
				<include name="**/db4ounit/common/**/*.java" />
			</fileset>
		</copy>
		
		<sharpen workspace="${target.dir}" resource="db4oj.tests/src">
			<args>
				<arg value="-cp" />
				<arg path="${dependencies.jar}" />
				
				<arg value="-namespaceMapping" />
				<arg value="com.db4o.db4ounit" />
				<arg value="Db4objects.Db4o.Tests" />
				
				<arg value="-typeMapping" />
				<arg value="com.db4o.test.lib.File4" />
				<arg value="System.IO.File" />
				
				<arg value="@sharpen-db4ounit-options" />
				<arg value="@sharpen-new-core-mapping" />
			</args>
		</sharpen>
		
		<property name="dir.n.v6.tests" location="${dir.n.v6}/Db4objects.Db4o.Tests" />
		<property name="dir.n.v6.tests.src" location="${dir.n.v6.tests}/Db4objects.Db4o.Tests" />
		
		<delete failonerror="false">
			<fileset dir="${dir.n.v6.tests.src}/Common">
				<include name="**/*.cs" />
				<exclude name="**/.svn/**" />
			</fileset>
		</delete>
		
		<copy todir="${dir.n.v6.tests.src}">
			<fileset dir="${target.dir}/db4oj.testscsharp/src/Db4objects/Db4o/Tests">
				<include name="**/*.cs" />
			</fileset>
		</copy>

		<updatecsharpproject projectfile="${dir.n.v6.tests}/Db4objects.Db4o.Tests-compact.csdproj">
			<sources dir="${dir.n.v6.tests}">
				<include name="**/*.cs" />
				<exclude name="**/compact-2005/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.v6.tests}/Db4objects.Db4o.Tests-compact-2005.csproj">
			<sources dir="${dir.n.v6.tests}">
				<include name="**/*.cs" />
				<exclude name="**/compact/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.v6.tests}/Db4objects.Db4o.Tests-2005.csproj">
			<sources dir="${dir.n.v6.tests}">
				<include name="**/*.cs" />
				<exclude name="**/compact*/**" />
			</sources>
		</updatecsharpproject>
		
		<updatecsharpproject projectfile="${dir.n.v6.tests}/Db4objects.Db4o.Tests.csproj">
			<sources dir="${dir.n.v6.tests}">
				<include name="**/*.cs" />
				<exclude name="**/compact*/**" />
			</sources>
		</updatecsharpproject>
	</target>
	
	<target name="init">
		<mkdir dir="${dir.dist.dll}" />
	</target>
	
	<target name="clean" description="Delete all generated files">
		<delete failonerror="false" includeemptydirs="true" description="Removing all generated files">
			<fileset dir="${dir.dist}">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

</project>