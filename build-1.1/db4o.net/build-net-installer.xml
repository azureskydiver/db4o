<?xml version="1.0"?>
<project name="db4oninstaller" default="build">
	<import file="../common-1.1.xml"/>
	
	<property name="dir.wix" location="${dir.build}/lib/wix" />	
	<property name="candle.exe" location="${dir.wix}/candle.exe" />
	<property name="light.exe" location="${dir.wix}/light.exe" />
	
	<target name="build">
		<resetDir dir="${tempOne}" />
		
		<!--
		set correct db4o's version in the build scripts
		-->
		<copy todir="${tempOne}" overwrite="true">
			<fileset dir="${dir.build}/src/installer">
				<include name="installer.wxs" />
				<include name="extra-parameters.xml" />
			</fileset>
			
			<filterset>
				<filter token="db4o.version.dotted" value="${db4o.version.dotted}" />
				<filter token="db4o.version.full" value="${db4o.version.full}" />
				<filter token="installer.package.guid" value="${installer.package.guid}" />
				<filter token="installer.upgrade.guid" value="${installer.upgrade.guid}" />
			</filterset>
		</copy>
		
		<exec executable="${candle.exe}" failonerror="true">
		
			<env key="resources.dir" path="${dir.build}/src/installer/resources" />
			<env key="appicon" path="${dir.dist.net.build.tutorial}/db4o-tutorial.exe" />
			
			<arg value="-nologo" />			
			<arg value="-out" />
			<arg file="${tempOne}/installer.wixobj" />
			<arg file="${tempOne}/installer.wxs" />
		</exec>		
		
		<csc targettype="exe" destfile="${tempOne}/WixBuilder.exe" executable="${csc.executable}">
			<src dir="${dir.build}/src/installer">
				<include name="WixBuilder.cs" />
			</src>
		</csc>
		
		<exec executable="${tempOne}/WixBuilder.exe" failonerror="true">
			<arg file="${dir.dist.net.build}" />
			<arg file="${tempOne}/extra-parameters.xml" />
			<arg file="${tempOne}/files.wxs" />
		</exec>		
		
		<exec executable="${candle.exe}" failonerror="true">
			<arg value="-nologo" />
			<arg value="-out" />
			<arg file="${tempOne}/files.wixobj" />
			<arg file="${tempOne}/files.wxs" />			
		</exec>
		
		<property name="installer.msi"
				location="${defaultArtifactDir}/db4o-${installer.package.suffix}.msi" />
		
		<exec executable="${light.exe}" failonerror="true">			
			<arg file="${tempOne}/installer.wixobj" />
			<arg file="${tempOne}/files.wixobj" />
			<arg value="-out" />
			<arg value="${installer.msi}" />
		</exec>
		
		<echo>msi package successfuly generated: ${installer.msi}</echo>
	</target>
	
</project>
