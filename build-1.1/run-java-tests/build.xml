<project name="run-java-tests" basedir="." default="run-tests"  xmlns:ivy="antlib:fr.jayasoft.ivy.ant">
	
	<import file="../common-1.1.xml"/>
	
	<property file="build.properties" />
	
	<target name="clean">
  	<cleanIvyDir/>
  	<delete dir="${runDir}" failonerror="true"/>
	</target>
	
	<target name="init" depends="">
		<tstamp />
		<initIvyDir/>
	</target>
	
	 <target name="configure" depends="init">
   	<ivy:configure file="${ivy.conf.dir}/ivyconf.xml" />
   </target>
   
   <target name="resolve" depends="configure">
   	<ivy:retrieve pattern="${ivy.lib.dir}/[conf]/[artifact].[ext]"/>
   </target>
  
  <target name="run-tests" depends="clean, resolve">
  	<!-- db4o java tests -->
  	<runJvmTests testsName="db4o 1.1" className="com.db4o.db4ounit.jre11.AllTests" 							classPathLibDir="${ivy.lib.dir}/1.1" 	jvm="${file.jvm.jdk1.1}"/>
  	<runJvmTests testsName="db4o 1.2" className="com.db4o.db4ounit.jre12.AllTestsJdk1_2"				classPathLibDir="${ivy.lib.dir}/1.2" 	jvm="${file.jvm.jdk1.2}"/>
  	<runJvmTests testsName="db4o 5" 	className="com.db4o.db4ounit.jre5.AllTestsDb4oUnitJdk5"		classPathLibDir="${ivy.lib.dir}/5" 		jvm="${file.jvm.jdk1.5}"/>
  	<runJvmTests testsName="db4o NQ x JVM 5" 	className="com.db4o.test.nativequery.AllTestsNQ"	classPathLibDir="${ivy.lib.dir}/nq" 	jvm="${file.jvm.jdk1.5}"/>
  	<runJvmTests testsName="db4o Defrag x JVM 5"	className="com.db4o.db4ounit.jre5.defrag.RunTestsDefrag"	classPathLibDir="${ivy.lib.dir}/5" 	jvm="${file.jvm.jdk1.5}"/>
  	
  	<!--runWithException()-->
  	<runJvmTests testsName="db4o 1.1 runWithException()" 	arg="*" className="com.db4o.test.AllTests"				classPathLibDir="${ivy.lib.dir}/1.1" 	jvm="${file.jvm.jdk1.1}"/>
  	<runJvmTests testsName="db4o 1.2 runWithException()" 	arg="*" className="com.db4o.test.AllTestsJdk1_2"	classPathLibDir="${ivy.lib.dir}/1.2" 	jvm="${file.jvm.jdk1.2}"/>
  	<runJvmTests testsName="db4o 5 runWithException()" 		arg="*" className="com.db4o.test.AllTestsJdk5"		classPathLibDir="${ivy.lib.dir}/5" 		jvm="${file.jvm.jdk1.5}"/>
  	<runJvmTests testsName="db4o Legacy x JVM 5 " 				arg="*" className="com.db4o.test.AllTestsLegacy"	classPathLibDir="${ivy.lib.dir}/5" 		jvm="${file.jvm.jdk1.5}"/>
  
  </target>
	
	<macrodef name="runJvmTests" description="Run some Java tests">
		<attribute name="testsName"/> 
		<attribute name="jvm"/> 
		<attribute name="classPathLibDir"/>
		<attribute name="className"/>
		<attribute name="timeOut" default="3600000"/>
		<attribute name="arg" default=""/> 
		<sequential>
			<echo message="Running @{testsName} tests..."/> 
			<path id="temp.path">
	  		<fileset dir="@{classPathLibDir}" includes="*.jar"/>
	  	</path>
			<delete dir="${runDir}" failonerror="true"/>
  		<copy todir="${runDir}">
				<fileset dir="${dir.j.jdk1.2}/test/db4oVersions"/>
			</copy>
			<copy todir="${runDir}">
				<fileset dir="${dir.j.tests}/test/db4oVersions"/>
			</copy>
			
			<copySrcDir srcDir="${dir.j.tests}" destDir="db4oj.tests" includes="test/**/*.yap"/>
			
			<java 
				jvm="@{jvm}" classname="@{className}" 
				classpathref="temp.path" timeout="@{timeOut}"
				dir="${runDir}" fork="true" failonerror="false" 
			> <!-- TODO WARNING
						turn failonerror to true when Production!!! 
				-->
				<arg value="@{arg}" />
			</java>
			
			<delete dir="db4oj.tests" failonerror="true"/>
			<delete dir="${runDir}" failonerror="true"/>			
			
			<!--<input message="@{testsName} tests done. Press Enter to continue..."/>-->
		</sequential>
	</macrodef>
</project>