<project name="build.net.common" basedir=".">
	<condition property="mono" value="true">
		<os family="unix" />
	</condition>

	<target name="configure" depends="configure-net2, configure-mono">
		<property name="debug" value="true" />
	</target>

	<target name="configure-net1" unless="mono">
		<echo>Configuring .net 1 build.</echo>
		
		<!-- don't build Db4oAdmin for .net 1.1 -->
		<property name="skip.admin" value="true" />
		
		<property name="target.framework.version" value="1.1" />
		<property name="csc.executable.path.net1" location="${env.SystemRoot}/Microsoft.NET/Framework/v1.1.4322" />
		<property name="csc.executable" location="${csc.executable.path.net1}/csc.exe" />
	
		<property name="csharp.definitions" value="NET_1_1" />
		<property name="csharp.definitions.cf" value="CF_1_0" />
		<property name="dir.libs.net" location="${dir.n.v6.libs}/net-1.1" />
		<property name="dir.dll.cf" location="${dir.compactframework}/v1.0/WindowsCE/" />
		<property name="dir.libs.cf" location="${dir.n.v6.libs}/compact-1.0" />
		<property name="csc.tests.extraoptions" value="" />
	
		<property name="installer.package.suffix" value="net1" />
		<property name="installer.package.guid" value="${installer.package.guid.net1}" />
		<property name="installer.upgrade.guid" value="${installer.upgrade.guid.net1}" />
	</target>
	<target name="configure-net2" unless="mono">
		<echo>Configuring .net 2 build.</echo>
		
		<property name="target.framework.version" value="2.0" />
		<property name="csc.executable.path.net2" location="${env.SystemRoot}/Microsoft.NET/Framework/v2.0.50727" />
		<property name="csc.executable" location="${csc.executable.path.net2}/csc.exe" />
	
		<property name="csharp.definitions" value="NET_2_0" />
		<property name="csharp.definitions.cf" value="CF_2_0" />		
		<property name="dir.libs.net" location="${dir.n.v6.libs}/net-2.0" />
		<property name="dir.dll.cf" location="${dir.compactframework}/v2.0/WindowsCE/" />
		<property name="dir.libs.cf" location="${dir.n.v6.libs}/compact-2.0" />
		<property name="csc.tests.extraoptions" value="" />
	
		<property name="installer.package.suffix" value="net2" />
		<property name="installer.package.guid" value="${installer.package.guid.net2}" />
		<property name="installer.upgrade.guid" value="${installer.upgrade.guid.net2}" />
	</target>
	<target name="configure-mono" if="mono">
		<echo>Configuring mono build.</echo>
		
		<property name="target.framework.version" value="2.0" />
		<property name="csharp.definitions" value="MONO,NET_2_0" />
		<property name="dir.libs.net" location="${dir.n.v6.libs}/net-2.0" />
		<property name="csc.executable" value="gmcs" />
		<property name="installer.package.suffix" value="mono2" />
	
		<property name="csc.tests.extraoptions" value="-r:System.Drawing" />
	</target>
	
		<macrodef name="sharpen">
		<attribute name="workspace" />
		<attribute name="resource" />
		
		<element name="args" optional="yes" />
		
		<sequential>
			<java jvm="${file.jvm.jdk1.5}" classname="org.eclipse.core.launcher.Main"
				fork="yes"
				failonerror="true"
				timeout="1800000"
				maxmemory="512M">
				<classpath>
					<pathelement location="${eclipse.home}/startup.jar" />
				</classpath>
					
				<arg value="-data" />
				<arg file="@{workspace}" />
				<arg value="-application" />
				<arg value="javatocsharp.core.application" />
				<arg value="@{resource}" />
				
				<args />
					
			</java>
		</sequential>
	</macrodef>
	

	<macrodef name="csc-all">
		<attribute name="assemblyName" />		
		<attribute name="sources" description="sources fileset id" />
		
		<attribute name="netOutputDir" default="${dir.dist.dll.net}" />
		<attribute name="netConfiguration" default=".NET" />
		
		<attribute name="compactOutputDir" default="${basedir}/${dir.dist.dll.compact}" />
		<attribute name="compactConfiguration" default=".NET CompactFramework" />
		
		<element name="references" optional="yes" />
		<element name="compact-args" optional="yes" />
		
		<sequential>
			<mkdir dir="@{netOutputDir}" />
			<mkdir dir="@{compactOutputDir}" />
			
			<resetDir dir="${dir.dist.net.compile}" />
			<copy todir="${dir.dist.net.compile}">
				<fileset refid="@{sources}" />
			</copy>			
			<prepare-assemblyInfo configuration="@{netConfiguration}" />
				
			<csc
				destfile="@{netOutputDir}/@{assemblyName}.dll"
				docfile="@{netOutputDir}/@{assemblyName}.xml"
				targettype="library"
				definitions="${csharp.definitions}"
				executable="${csc.executable}"
				debug="${debug}"
				optimize="true"
				warnlevel="0"
				srcdir="${dir.dist.net.compile}">
				
				<include name="**/*.cs" />
				
				<references />
			</csc>
			
			<if>
			<equals arg1="${mono}" arg2="true" />
			<then>
				<echo>skipping CompactFramework build</echo>
			</then>
			<else>
				<prepare-assemblyInfo configuration="@{compactConfiguration}" />
				
				<exec executable="${csc.executable}" dir="${dir.dist.net.compile}" failonerror="true">
					<arg value="/optimize" />
					<arg value="/debug-" />
					<arg value="/define:${csharp.definitions.cf}" />
					<arg value="/out:@{compactOutputDir}/@{assemblyName}.dll" />
					<arg value="/target:library" />
					<arg value="/warn:0" />
					<arg value="/noconfig" />
					<arg value="/nostdlib" />
					<arg value="/r:${dir.dll.cf}/mscorlib.dll" />
					<arg value="/r:${dir.dll.cf}/System.dll" />
					<arg value="/doc:@{compactOutputDir}/@{assemblyName}.xml" />
					<compact-args />
					<arg value="/recurse:*.cs" />
				</exec>
			</else>
			</if>
			
		</sequential>
	</macrodef>
	
	<macrodef name="prepare-assemblyInfo">
		<attribute name="configuration" />
		<sequential>
			<echo>ABC ${target.framework.version}</echo>
			<updateAssemblyInfo
				keyfile="${filename.keyfile}"
				version="${db4o.version.full}"
				
		configuration="@{configuration} ${target.framework.version}">
				<fileset dir="${dir.dist.net.compile}">
					<include name="**/AssemblyInfo.cs" />
				</fileset>
			</updateAssemblyInfo>
		</sequential>
	</macrodef>
	
	<if>
		<equals arg1="${compiledll.debug}" arg2="true" />
		<then>
			<property name="compiledll.debug.symbol" value="+" />
		</then>
		<else>
			<property name="compiledll.debug.symbol" value="-" />
		</else>
	</if>

</project>