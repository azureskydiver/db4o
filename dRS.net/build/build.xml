<project name="Db4objects.Drs" default="publish"  xmlns:ivy="antlib:fr.jayasoft.ivy.ant">
	<import file="../../build-1.1/common-1.1.xml"/>
	<property file="build.properties" />
	
	<copy todir="${dir.dRS.net.build}">
		<fileset dir="${dir.old.build}">
			<include name="sharpen*" />
		</fileset>
	</copy>
	
	<condition property="mono" value="1">
		<os family="unix" />
	</condition>
	
	<target name="clean">
		<cleanIvyDir/>
	</target>
	<target name="init" depends="clean, select-db4o-assembly">
		<tstamp />
		<initIvyDir/>
		<buildDb4oDevTool/>		
	</target>
	<target name="select-db4o-assembly" depends="select-mono-assembly, select-dotnet-assembly">
	</target>
	<target name="select-dotnet-assembly" unless="mono">
		<property name="csc.executable" location="${csc.executable.path.net2}/csc.exe" />
	</target>
	<target name="select-mono-assembly" if="mono">	
		<property name="csc.executable" value="gmcs" />
	</target>
	<target name="configure" depends="init">
		<ivy:configure file="${ivy.conf.dir}/ivyconf.xml" />
	</target>
	<target name="resolve" depends="configure">   
		<ivy:retrieve/>
	</target>	
	<target name="zip" depends="update-drs-project, update-test-project">
		<copy todir="${tempdll}">
			<fileset dir="${defaultArtifactDir}">
				<include name="*.dll"/>
			</fileset>
		</copy>
		<renameDll srcJarDir="${tempdll}"/>
		<!--
		<zip destfile="${zipPath}">
			<zipfileset dir="${ivy.lib.dir}" prefix="${zipDir}/lib"/>
			<zipfileset dir="${tempJar}" prefix="${zipDir}/lib"/>
			<zipfileset dir="." prefix="${zipDir}" includes="machine.properties, ant.properties, build.xml, *.txt" />
			<zipfileset dir="${drsLibDir}" prefix="${zipDir}/lib" includes="*.jar, *.txt" />
					
			<zipfileset dir="${drs.basedir}/doc/out" prefix="${zipDir}/doc/tutorial" />		
			<zipfileset dir="${tempApi}" prefix="${zipDir}/doc/api" />
			<zipfileset file="${tempSrcZipPath}" prefix="${zipDir}"/>	
		</zip>	
		
		<delete dir="${tempSrcDir}" failonerror="true"/>
		-->
	</target>
	<target name="publish" depends="zip">
		<!--
		<publishToIvy/>
		<antcall target="clean" />
		-->
		<delete>
			<fileset dir="." includes="sharpen*"/>
		</delete>
	</target>
	
	<target name="prepare-conversion-workspace" depends="resolve">
		<copy todir="${drs.src.filtered}">
			<fileset dir="${dir.dRS.src}">
				<include name="core/**/*.java" />
				
				<include name="test/**/test/Db4oClientServerDrsFixture.java" />
				<include name="test/**/test/ByteArrayTest.java" />
				<include name="test/**/test/IByteArrayHolder.java" />
				<include name="test/**/test/ByteArrayHolder.java" />
				<include name="test/**/test/Db4oDrsFixture.java" />
				<include name="test/**/test/Db4oTests.java" />
				<include name="test/**/test/DrsFixture.java" />				
				<include name="test/**/test/DrsTestCase.java" />
				<include name="test/**/test/DrsTestSuite.java" />
				<include name="test/**/test/DrsTestSuiteBuilder.java" />					
				<include name="test/**/test/ReplicationProviderTest.java" />
				<include name="test/**/test/GetByUUID.java" />
				<include name="test/**/test/TheSimplest.java" />
				<include name="test/**/test/SPCChild.java" />
				<include name="test/**/test/SPCParent.java" />
				<include name="test/**/test/Pilot.java" />
				<include name="test/**/test/Car.java" />
				<include name="test/**/test/SimpleParentChild.java" />
				<include name="test/**/test/ReplicationEventTest.java" />
				<include name="test/**/test/ReplicationAfterDeletionTest.java" />
				<include name="test/**/test/SimpleArrayTest.java" />
				<include name="test/**/test/SimpleArrayHolder.java" />
				<include name="test/**/test/SimpleArrayContent.java" />
				<include name="test/**/test/ListTest.java" />
				<include name="test/**/test/ListHolder.java" />
				<include name="test/**/test/ListContent.java" />					
				<include name="test/**/test/Db4oListTest.java" />					
				<include name="test/**/test/R0to4Runner.java" />
				<include name="test/**/test/R0.java" />
				<include name="test/**/test/R0Linker.java" />
				<include name="test/**/test/R1.java" />
				<include name="test/**/test/R2.java" />
				<include name="test/**/test/R3.java" />
				<include name="test/**/test/R4.java" />
				<include name="test/**/test/ReplicationFeaturesMain.java" />
				<include name="test/**/test/Replicated.java" />				
				<include name="test/**/test/Person.java" />				
				<include name="test/**/test/Student.java" />				
		
				<include name="test/**/test/CollectionHolder.java" />
				<include name="test/**/test/MapHolder.java" />
				<include name="test/**/test/MapContent.java" />				
				
				<exclude name="**/hibernate/**" />
				<exclude name="**/CollectionHandlerImplTest.java" />
				<exclude name="**/ReplicationTraversalTest.java" />
			</fileset>
		</copy>
	</target>
	<target name="sharpen-drs" depends="prepare-conversion-workspace">
		<sharpen resource="drs/core" workspace="${drs.conversion.workspace.dir}">
			<args>
				<arg value="-cp" />
				<arg path="${ivy.lib.dir}/db4o-java5-${db4o.version.dotted}.jar" />
				<arg value="@sharpen-dRS-options" />
			</args>
		</sharpen>
	</target>
	<target name="build-drs" depends="sharpen-drs">
		<copy todir="${tmp.Db4objects.Drs.src.dir}">
			<fileset dir="${drs.conversion.workspace.dir}/drscsharp/src/Db4objects/Drs">
				<exclude name="**/ObjectSetAbstractFacade.cs" />
				<exclude name="**/ObjectSetCollection4Facade.cs" />
				<exclude name="**/ReplicationPlatform.cs" />			
			</fileset>
		</copy>
		<copy todir="${tmp.Db4objects.Drs.dir}/native">
			<fileset dir="${Db4objects.Drs.dir}/native"/>
		</copy>
		<copy todir="${tmp.Db4objects.Drs.dir}/Properties">
			<fileset dir="${Db4objects.Drs.dir}/Properties"/>
		</copy>
		<updateAssemblyInfo
			drs="true"
			version="${db4o.version.full}"
			configuration=".Net 2.0">
			<fileset dir="${tmp.Db4objects.Drs.dir}/Properties">
			<include name="AssemblyInfo.cs" />
		</fileset>
		</updateAssemblyInfo>
		<csc outputfile="${Db4objects.Drs.dll.path}"
			executable="${csc.executable}"
			targettype="library"
			srcdir="${tmp.Db4objects.Drs.dir}">
			<reference dir="${ivy.lib.dir}">
				<include name="Db4objects.Db4o-${db4o.version.dotted}.dll" />
			</reference>
		</csc>
	</target>
	<target name="update-drs-project" depends="build-drs">
		<copy todir="${tmp.Db4objects.Drs.dir}" file="${Db4objects.Drs.dir}/Db4objects.Drs.csproj"/>
		<updatecsharpproject projectfile="${tmp.Db4objects.Drs.dir}/Db4objects.Drs.csproj">
			<sources dir="${tmp.Db4objects.Drs.dir}">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject>
	</target>
	<target name="sharpen-test" depends="build-drs">		
		<sharpen resource="drs/test" workspace="${drs.conversion.workspace.dir}">
			<args>
				<arg value="-cp" />
				<arg path="${ivy.lib.dir}/db4o-java5-${db4o.version.dotted}.jar" />
				<arg value="-cp" />
				<arg path="${ivy.lib.dir}/db4ounit-${db4o.version.dotted}.jar" />	
				<arg value="-cp" />
				<arg path="${ivy.lib.dir}/dRS-${db4o.version.dotted}.jar" />				
				<arg value="@sharpen-dRS-options" />
			</args>
		</sharpen>
	</target>
	<target name="build-test" depends="sharpen-test">
		<copy todir="${tmp.Db4objects.Drs.Test.src.dir}">
			<fileset dir="${drs.conversion.workspace.dir}/drscsharp/src/Db4objects/Drs/Test"/>
		</copy>
		<csc outputfile="${Db4objects.Drs.Test.dll.path}"
			executable="${csc.executable}"
			targettype="library"
			srcdir="${tmp.Db4objects.Drs.Test.dir}">
			<reference dir="${ivy.lib.dir}">
				<include name="Db4objects.Db4o-${db4o.version.dotted}.dll" />
				<include name="Db4oUnit-${db4o.version.dotted}.dll" />
			</reference>
			<reference dir="${defaultArtifactDir}">
				<include name="${Db4objects.Drs.dll}" />
			</reference>
		</csc>
	</target>
	<target name="update-test-project" depends="build-test">
		<copy todir="${tmp.Db4objects.Drs.Test.dir}" file="${Db4objects.Drs.Test.dir}/Db4objects.Drs.Test.csproj"/>
		<updatecsharpproject projectfile="${tmp.Db4objects.Drs.Test.dir}/Db4objects.Drs.Test.csproj">
			<sources dir="${tmp.Db4objects.Drs.Test.dir}">
				<include name="**/*.cs" />
			</sources>
		</updatecsharpproject>
	</target>
	
	<target name="tutorial" depends="resolve">
		<delete dir="tutorial/out" />
		<java classname="com.yetac.doctor.Doctor">
			<arg line="tutorial ${font.pdf.base}" />
			<classpath>
				<fileset dir="${ivy.lib.dir}">
					<include name="*.jar" />
				</fileset>
				<fileset dir="${dir.dRS}/lib/doctor">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<move file="tutorial/out/doctor.pdf" tofile="tutorial/out/dRS.net-tutorial.pdf"/>
	</target>
</project>